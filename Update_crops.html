<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Manage Crops - Krishi Mitr</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="supabase.js"></script>
<style>
* { box-sizing: border-box; }
body {
    margin: 0;
    font-family: "Poppins", Arial, sans-serif;
    min-height: 100vh;
    background: linear-gradient(180deg, #f6e2cc 0%, #f7f9f8 45%, #dceee3 100%);
    color: #1f2937;
}
body.drawer-open { overflow: hidden; }
.top-nav {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    height: 78px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0 32px;
    background: linear-gradient(90deg,#ff9933,#ffffff,#138808);
    border-bottom: 3px solid #0a3d62;
    box-shadow: 0 6px 14px rgba(0,0,0,0.15);
    z-index: 9999;
}
.nav-left { display: flex; align-items: center; gap: 14px; }
.hamburger-btn {
    width: 44px; height: 44px; border-radius: 12px; border: 2px solid #0a3d62;
    background: rgba(255,255,255,0.75); display: grid; place-items: center; cursor: pointer;
}
.hamburger-icon { width: 20px; height: 14px; position: relative; }
.hamburger-icon span { position: absolute; left: 0; right: 0; height: 2.5px; background: #0a3d62; border-radius: 999px; }
.hamburger-icon span:nth-child(1) { top:0; }
.hamburger-icon span:nth-child(2) { top:5.5px; }
.hamburger-icon span:nth-child(3) { top:11px; }
.brand-title { font-weight: 800; color: #0a3d62; margin: 0; }
.logout-btn {
    background: white; color: #0a3d62; border: 2px solid #0a3d62;
    padding: 10px 18px; border-radius: 10px; font-weight: 700; cursor: pointer;
}
.nav-overlay {
    position: fixed; inset: 0; background: rgba(0,0,0,0.25);
    opacity: 0; pointer-events: none; transition: .2s ease; z-index: 9998;
}
.side-drawer {
    position: fixed; top: 84px; left: 14px; width: min(320px, calc(100vw - 28px));
    max-height: calc(100vh - 98px); overflow: auto;
    background: linear-gradient(180deg,#0a3d62,#082032);
    border: 3px solid #ffffff; border-radius: 18px;
    box-shadow: 0 18px 40px rgba(0,0,0,0.35);
    transform: translateX(-110%); transition: .25s ease; z-index: 9999;
}
.drawer-inner { padding: 14px; }
.menu-section {
    border-radius: 14px; overflow: hidden; border: 1px solid rgba(255,255,255,0.15);
    margin-bottom: 14px; background: rgba(255,255,255,0.05);
}
.menu-section-title { padding: 12px 14px; background: rgba(255,255,255,0.1); color: white; font-weight: 800; font-size: 0.95rem; }
.menu-list { list-style: none; padding: 0; margin: 0; }
.menu-list a {
    display: block; padding: 14px; text-decoration: none; color: white;
    font-weight: 600; transition: 0.2s ease; background: rgba(255,255,255,0.08);
}
.menu-list a:hover { background: #1e3a8a; padding-left: 20px; }
body.drawer-open .nav-overlay { opacity: 1; pointer-events: auto; }
body.drawer-open .side-drawer { transform: translateX(0); }
.container { max-width: 1100px; margin: 120px auto 60px; padding: 0 20px; }
.page-title { text-align: center; font-size: 2.2rem; font-weight: 800; color: #0a3d62; margin-bottom: 40px; }
.crop-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 25px; }
.crop-card {
    background: white; border-radius: 20px; padding: 24px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.06); cursor: pointer;
    border-left: 6px solid #ff9933; transition: transform 0.3s ease, box-shadow 0.3s ease;
}
.crop-card:hover { transform: translateY(-8px); box-shadow: 0 15px 35px rgba(0,0,0,0.12); }
.modal {
    position: fixed; inset: 0; background: rgba(10, 61, 98, 0.7);
    backdrop-filter: blur(10px); display: none; align-items: center;
    justify-content: center; z-index: 10000; padding: 20px;
}
.modal-box {
    width: 100%; max-width: 800px; max-height: 85vh;
    background: white; padding: 35px; border-radius: 28px;
    overflow-y: auto; box-shadow: 0 30px 60px rgba(0,0,0,0.25);
}
.form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 18px; }
.form-group { display: flex; flex-direction: column; }
.form-group.full { grid-column: span 2; }
.form-group label { font-weight: 700; font-size: 0.85rem; color: #4b5563; margin-bottom: 8px; }
.form-group input, .form-group select, .form-group textarea {
    padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 12px; font-size: 1rem;
}
.modal-footer { display: flex; gap: 15px; margin-top: 35px; }
.btn { flex: 1; padding: 16px; border: none; border-radius: 14px; font-weight: 800; cursor: pointer; }
.btn-update { background: #138808; color: white; }
.btn-delete { background: #fee2e2; color: #dc2626; }
.btn-close { background: #f3f4f6; color: #4b5563; }
</style>
</head>
<body>

<div class="top-nav">
    <div class="nav-left">
        <button class="hamburger-btn" id="menuBtn"><div class="hamburger-icon"><span></span><span></span><span></span></div></button>
        <p class="brand-title">Krishi Mitr</p>
    </div>
    <button class="logout-btn" id="logoutBtn">Logout</button>
</div>

<div class="nav-overlay" id="navOverlay" hidden></div>
<nav class="side-drawer" id="sideNav" hidden>
    <div class="drawer-inner">
        <div class="menu-section">
            <div class="menu-section-title">Main</div>
            <ul class="menu-list">
                <li><a href="Dashboard">Dashboard</a></li>
            </ul>
        </div>
        <div class="menu-section">
            <div class="menu-section-title">Market</div>
            <ul class="menu-list">
                <li><a href="Update_crops">Manage Your Crops</a></li>
                <li><a href="Sell">Sell Your Crop</a></li>
            </ul>
        </div>
        <div class="menu-section">
            <div class="menu-section-title">Tools & Services</div>
            <ul class="menu-list">
                <li><a href="Buy">Buy Crops</a></li>
                <li><a href="browse_tools.html">Rent Tools & Machinery</a></li>
                <li><a href="tools_rental.html">List Tool for Rent</a></li>
                <li><a href="my_listings.html">My Tool Inventory</a></li>
                <li><a href="krishimitr">Crop Predictor</a></li>
            </ul>
        </div>
        <div class="menu-section">
            <div class="menu-section-title">System</div>
            <ul class="menu-list">
                <li><a href="Notification">Notification</a></li>
                <li><a href="Chat">Chat</a></li>
            </ul>
        </div>
    </div>
</nav>

<div class="container">
    <h1 class="page-title">Manage Your Crop Inventory</h1>
    <div id="cropList" class="crop-grid"></div>
</div>

<div class="modal" id="modal">
    <div class="modal-box">
        <div class="modal-header"><h3>Update Crop Specifications</h3></div>
        <div class="form-grid">
            <div class="form-group"><label>Crop Name</label><input type="text" id="upd_name"></div>
            <div class="form-group">
                <label>Category</label>
                <select id="upd_category">
                    <option value="Grains">Grains</option>
                    <option value="Vegetables">Vegetables</option>
                    <option value="Fruits">Fruits</option>
                    <option value="Pulses">Pulses</option>
                </select>
            </div>
            <div class="form-group"><label>Price (₹ per kg)</label><input type="number" id="upd_price"></div>
            <div class="form-group"><label>Total Quantity (kg)</label><input type="number" id="upd_qty"></div>
            <div class="form-group"><label>Min Order (kg)</label><input type="number" id="upd_min_qty"></div>
            <div class="form-group">
                <label>Quality</label>
                <select id="upd_quality">
                    <option value="Grade A">Grade A</option>
                    <option value="Grade B">Grade B</option>
                    <option value="Grade C">Grade C</option>
                </select>
            </div>
            <div class="form-group"><label>Harvest Date</label><input type="date" id="upd_harvest"></div>
            <div class="form-group"><label>Available Until</label><input type="date" id="upd_expiry"></div>
            <div class="form-group full"><label>Location</label><input type="text" id="upd_location"></div>
            <div class="form-group full"><label>Contact</label><input type="text" id="upd_contact"></div>
            <div class="form-group full"><label>Description</label><textarea id="upd_description" rows="3"></textarea></div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-update" onclick="submitChanges()">Apply Updates</button>
            <button class="btn btn-delete" onclick="handleDeletion()">Remove Listing</button>
            <button class="btn btn-close" onclick="closeModal()">Discard</button>
        </div>
    </div>
</div>

<script>
const db = window.db;
const loginid = sessionStorage.getItem("loginid");
const usertype = sessionStorage.getItem("usertype");

if (!loginid || usertype !== "Farmer") {
    location.href = "Dashboard";
}

let activeCropId = null;
let activeJid = null;
let localCropBuffer = [];

async function fetchFarmerCrops() {
    const container = document.getElementById("cropList");
    const { data, error } = await db.from("crop_sales").select("*").eq("lid", loginid);
    if (error) return;
    localCropBuffer = data;
    container.innerHTML = data.map((crop, index) => `
        <div class="crop-card" onclick="triggerEditModal(${index})">
            <div style="font-size: 0.75rem; font-weight: 800; color: #ff9933; text-transform: uppercase;">${crop.crop_category}</div>
            <h3 style="margin: 5px 0; color: #0a3d62;">${crop.crop_name}</h3>
            <div style="display: flex; justify-content: space-between;">
                <span style="font-weight: 700; color: #138808;">₹${crop.price}/kg</span>
                <span style="color: #6b7280;">Stock: ${crop.quantity}kg</span>
            </div>
        </div>
    `).join("");
}

function triggerEditModal(index) {
    const crop = localCropBuffer[index];
    activeCropId = crop.id;
    activeJid = crop.jid;
    document.getElementById("upd_name").value = crop.crop_name;
    document.getElementById("upd_category").value = crop.crop_category;
    document.getElementById("upd_price").value = crop.price;
    document.getElementById("upd_qty").value = crop.quantity;
    document.getElementById("upd_min_qty").value = crop.min_quantity;
    document.getElementById("upd_quality").value = crop.quality;
    document.getElementById("upd_harvest").value = crop.harvest_date;
    document.getElementById("upd_expiry").value = crop.available_until;
    document.getElementById("upd_location").value = crop.location;
    document.getElementById("upd_contact").value = crop.contact_info;
    document.getElementById("upd_description").value = crop.description;
    document.getElementById("modal").style.display = "flex";
}

function closeModal() { document.getElementById("modal").style.display = "none"; }

async function submitChanges() {
    const updateData = {
        crop_name: document.getElementById("upd_name").value,
        crop_category: document.getElementById("upd_category").value,
        price: parseFloat(document.getElementById("upd_price").value),
        quantity: parseInt(document.getElementById("upd_qty").value),
        min_quantity: parseInt(document.getElementById("upd_min_qty").value),
        quality: document.getElementById("upd_quality").value,
        harvest_date: document.getElementById("upd_harvest").value,
        available_until: document.getElementById("upd_expiry").value,
        location: document.getElementById("upd_location").value,
        contact_info: document.getElementById("upd_contact").value,
        description: document.getElementById("upd_description").value
    };
    await db.from("crop_sales").update(updateData).eq("id", activeCropId);
    await db.from("buy_table").update({
        cname: updateData.crop_name,
        cid: updateData.crop_category,
        quantity: updateData.quantity
    }).eq("fid", activeJid);
    closeModal();
    fetchFarmerCrops();
}

async function handleDeletion() {
    if (!confirm("Delete listing?")) return;
    await db.from("buy_table").delete().eq("fid", activeJid);
    await db.from("crop_sales").delete().eq("id", activeCropId);
    closeModal();
    fetchFarmerCrops();
}

const menuBtn = document.getElementById("menuBtn");
const sideNav = document.getElementById("sideNav");
const navOverlay = document.getElementById("navOverlay");

menuBtn.onclick = () => {
    const isOpen = document.body.classList.toggle("drawer-open");
    sideNav.hidden = !isOpen;
    navOverlay.hidden = !isOpen;
};

navOverlay.onclick = () => {
    document.body.classList.remove("drawer-open");
    sideNav.hidden = true;
    navOverlay.hidden = true;
};

document.getElementById("logoutBtn").onclick = () => { sessionStorage.clear(); location.href="login"; };

fetchFarmerCrops();
</script>
</body>
</html>
