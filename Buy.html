<!DOCTYPE html>
<html>
<head>
<title>Buy Crops - KrishiMitra</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="supabase.js"></script>

<style>
body{
  background: linear-gradient(to bottom, hsl(37,91%,91%) 50%, #ffffff 100%);
  font-family: Arial;
  padding-top:100px;
}

.top-nav{
  position:fixed;
  top:0; left:0; right:0;
  height:78px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:0 30px;
  background:linear-gradient(90deg,#ff9933,#ffffff,#138808);
  border-bottom:3px solid #0a3d62;
  z-index:9999;
}

.logout-btn{
  background:white;
  border:2px solid #0a3d62;
  padding:8px 20px;
  border-radius:8px;
  font-weight:700;
  color:#0a3d62;
}

.card-custom{
  border:3px solid #0a3d62;
  border-radius:15px;
  padding:18px;
  box-shadow:0 4px 18px rgba(0,0,0,0.2);
}

.buy-btn{
  width:100%;
  background:#0a3d62;
  color:white;
  border:none;
  padding:8px;
  border-radius:8px;
  font-weight:700;
}

.success-box{
  position:fixed;
  top:100px;
  right:20px;
  background:#28a745;
  color:white;
  padding:15px 25px;
  border-radius:10px;
  box-shadow:0 4px 15px rgba(0,0,0,0.3);
  display:none;
  z-index:99999;
}
</style>
</head>

<body>

<div class="top-nav">
  <h4 style="margin:0;font-weight:800;color:#0a3d62;">Krishi Mitr - Buy Crops</h4>
  <button class="logout-btn" onclick="logout()">Logout</button>
</div>

<div class="container">
  <h2 class="text-center mb-4" style="color:#0a3d62;">Available Crops</h2>
  <div class="row g-4" id="cropList"></div>
</div>

<div class="success-box" id="successBox">
  ✅ Purchase Successful!
</div>

<script>
const loginid = parseInt(sessionStorage.getItem("loginid"));
if(!loginid){ window.location.href="login.html"; }

async function waitForDB(){
  let attempts=0;
  while(!window.db && attempts<50){
    await new Promise(r=>setTimeout(r,100));
    attempts++;
  }
}

async function loadCrops(){
  const { data:crops } = await window.db
    .from("crop_sales")
    .select("*")
    .neq("lid", loginid);

  const container=document.getElementById("cropList");
  container.innerHTML="";

  if(!crops || crops.length===0){
    container.innerHTML="<p class='text-center text-muted'>No crops available.</p>";
    return;
  }

  crops.forEach(crop=>{
    container.innerHTML+=`
    <div class="col-md-4">
      <div class="card-custom">
        <h5 style="color:#0a3d62;font-weight:700;">${crop.crop_name}</h5>
        <p><strong>Farmer:</strong> ${crop.farmer_name}</p>
        <p><strong>Price:</strong> ₹${crop.price}/kg</p>
        <button class="buy-btn" onclick="showDetails(${crop.jid})">Buy</button>
      </div>
    </div>`;
  });
}

async function showDetails(id){
  const { data:crop } = await window.db
    .from("crop_sales")
    .select("*")
    .eq("jid",id)
    .maybeSingle();

  if(!crop) return;

  const quantity = prompt(
`Crop: ${crop.crop_name}
Farmer: ${crop.farmer_name}
Available: ${crop.quantity} kg
Price: ₹${crop.price}/kg

Enter quantity you want to buy:`);

  if(!quantity || quantity<=0 || quantity>crop.quantity){
    alert("Invalid quantity.");
    return;
  }

  await window.db.from("buy_table").insert({
    fid: id,
    cid: loginid,
    lid: crop.lid,
    quantity: quantity,
    total_price: crop.price * quantity,
    status: "pending",
    created_at: new Date().toISOString()
  });

  showSuccess();
}

function showSuccess(){
  const box=document.getElementById("successBox");
  box.style.display="block";
  setTimeout(()=>{ box.style.display="none"; },3000);
}

function logout(){
  sessionStorage.clear();
  location.href="login.html";
}

waitForDB().then(loadCrops);
</script>

</body>
</html>
