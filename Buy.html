<!DOCTYPE html>
<html>
<head>
<title>Buy Crops - KrishiMitra</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
body {
  background: linear-gradient(to bottom, #FF9933 0%, #FFFFFF 50%, #138808 100%);
  background-attachment: fixed;
  font-family: Arial;
  padding-top: 90px;
}

.topbar {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    height: 78px;
    display: flex;
    align-items: center;
    padding: 0 18px;
    background: linear-gradient(90deg, #FF9933, #FFFFFF 50%, #138808);
    border-bottom: 3px solid #000080;
    box-shadow: 0 4px 12px rgba(0,0,0,0.25);
    z-index: 9000;
}

.topbar-logo {
    font-size: 26px;
    font-weight: 900;
    color: #000080;
    margin-right: 25px;
}

.topbar-menu {
    display: flex;
    gap: 14px;
}

.topbar-menu a {
    text-decoration: none;
    padding: 10px 16px;
    border-radius: 8px;
    font-weight: 700;
    color: #000080;
}

.topbar-right {
    margin-left: auto;
}

.topbar-right a {
    padding: 8px 16px;
    background: #000080;
    color: white;
    text-decoration: none;
    border-radius: 8px;
    font-weight: 700;
}

.card-custom {
    border: 3px solid #000080;
    border-radius: 15px;
    background: white;
    padding: 18px;
    box-shadow: 0 4px 18px rgba(0,0,0,0.22);
}

.buy-btn {
    padding: 8px 16px;
    border: none;
    background: #000080;
    color: white;
    border-radius: 8px;
    font-weight: 700;
}
</style>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>

<div class="topbar">
    <div class="topbar-logo">ðŸŒ¾ KrishiMitra</div>
    <div class="topbar-menu" id="menu"></div>
    <div class="topbar-right"><a href="#" id="logoutBtn">Logout</a></div>
</div>

<div class="container">
    <h2 class="text-center mb-4" style="color:#000080;">Available Crops & Seeds</h2>
    <div class="row g-4" id="cropList"></div>
</div>

<script>
const supabase = supabase.createClient(
  'https://xhzpvgiyvxcfwgnupkqv.supabase.co',
  'sb_publishable_YviwlBy7i3PmxZ88mwsDeQ_P4Bg0naI'
);

let user, loginid, username, usertype;
async function checkAuth() {
  const { data } = await supabase.auth.getUser();
  if (!data.user) {
    window.location.href = "login.html";
    return;
  }

  user = data.user;
  loginid = user.id;
  username = user.user_metadata.username;
  usertype = user.user_metadata.usertype;

  renderMenu();
  loadCrops();
}
function renderMenu() {
  const menu = document.getElementById('menu');

  menu.innerHTML = `
    <a href="Dashboard.html">Main Page</a>
    ${usertype === "Farmer" ? `<a href="Notification.html">Notification</a>` : ""}
    <a href="krishimitr.html">Crop Predictor and Advisor</a>
    ${usertype === "Farmer" ? `<a href="Sell.html">Sell Crops</a>` : ""}
  `;
}
async function loadCrops() {
  const { data: crops } = await supabase
    .from('crop_sales')
    .select('*')
    .neq('ID', loginid)
    .order('created_at', { ascending: false });

  const container = document.getElementById('cropList');
  container.innerHTML = '';

  for (let row of crops) {

    const { data: buyRow } = await supabase
      .from('buy_table')
      .select('"Y/N"')
      .eq('FID', row.JID)
      .eq('CID', loginid)
      .single();

    const yn = buyRow ? buyRow["Y/N"] : "No";

    container.innerHTML += `
      <div class="col-md-4">
        <div class="card-custom">
          <h4 style="color:#000080;font-weight:700;">${row.crop_name}</h4>
          <p><strong>Farmer:</strong> ${row.farmer_name}</p>
          <p><strong>Quantity:</strong> ${row.quantity} kg</p>
          <p><strong>Price:</strong> â‚¹${row.price} per kg</p>
          <p><strong>Location:</strong> ${row.location}</p>
          <p class="text-muted" style="font-size:12px;">Posted on: ${row.created_at}</p>

          <button class="buy-btn"
            onclick="toggleBuy('${row.JID}','${row.farmer_name}',this)">
            ${yn}
          </button>
        </div>
      </div>
    `;
  }
}
async function toggleBuy(fid, fname, btn) {

  const { data: farmer } = await supabase
    .from('crop_sales')
    .select('LID')
    .eq('JID', fid)
    .single();

  const farmer_lid = farmer.LID;

  const { data: existing } = await supabase
    .from('buy_table')
    .select('"Y/N"')
    .eq('FID', fid)
    .eq('CID', loginid)
    .eq('LID', farmer_lid)
    .single();

  if (existing) {
    const newVal = existing["Y/N"] === "Yes" ? "No" : "Yes";

    await supabase
      .from('buy_table')
      .update({ "Y/N": newVal })
      .eq('FID', fid)
      .eq('CID', loginid)
      .eq('LID', farmer_lid);

    btn.innerText = newVal;
  } else {
    await supabase.from('buy_table').insert({
      FName: fname,
      FID: fid,
      CName: username,
      CID: loginid,
      LID: farmer_lid,
      "Y/N": "Yes"
    });

    btn.innerText = "Yes";
  }
}
document.getElementById('logoutBtn').onclick = async () => {
  await supabase.auth.signOut();
  window.location.href = "login.html";
};

checkAuth();
</script>

</body>
</html>
