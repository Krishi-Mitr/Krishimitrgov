<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Buy Crops - Krishi Mitr</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="supabase.js"></script>

<style>
  body {
    margin: 0;
    font-family: "Poppins", Arial, sans-serif;
    min-height: 100vh;
    background: linear-gradient(180deg,#f6e2cc 0%,#f7f9f8 45%,#dceee3 100%);
    color: #1f2937;
  }

  /* NAVBAR */
  .top-nav {
    position: fixed;
    top: 0; left: 0; right: 0;
    height: 78px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0 32px;
    background: linear-gradient(90deg,#ff9933,#ffffff,#138808);
    border-bottom: 3px solid #0a3d62;
    box-shadow: 0 6px 14px rgba(0,0,0,0.15);
    z-index: 9999;
  }
  .nav-left {
    display: flex;
    gap: 16px;
  }
  .nav-box {
    background: #0a3d62;
    color: white;
    padding: 10px 20px;
    border-radius: 10px;
    font-weight: 600;
    text-decoration: none;
    transition: .25s;
    cursor: pointer;
  }
  .nav-box:hover {
    background: linear-gradient(135deg,#ff9933,#ffd28a);
    color: black;
    transform: translateY(-3px);
  }
  .logout-btn {
    background: white;
    color: #0a3d62;
    border: 2px solid #0a3d62;
    padding: 10px 22px;
    border-radius: 10px;
    font-weight: 700;
    cursor: pointer;
  }

  /* CONTAINER */
  .container {
    max-width: 960px;
    margin: 110px auto 60px;
    padding: 0 20px;
  }

  /* Crop cards */
  .crop-card {
    background: white;
    border-radius: 20px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    cursor: pointer;
    transition: box-shadow 0.3s ease;
  }
  .crop-card:hover {
    box-shadow: 0 15px 40px rgba(0,0,0,0.2);
  }
  .crop-title {
    font-weight: 700;
    font-size: 1.3em;
    color: #0a3d62;
  }
  .crop-details {
    margin-top: 8px;
    color: #374151;
    font-size: 0.95em;
  }
  .crop-details span {
    font-weight: 600;
  }

  /* Popup modal */
  #popup {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.5);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 10000;
  }
  #popup-content {
    background: white;
    padding: 25px 30px;
    border-radius: 18px;
    width: 90%;
    max-width: 600px;
    box-shadow: 0 15px 40px rgba(0,0,0,0.25);
    position: relative;
  }
  #popup-content h2 {
    margin-top: 0;
    color: #0a3d62;
  }
  #popup-content p {
    margin: 6px 0;
    color: #374151;
  }
  #popup-close {
    position: absolute;
    top: 12px; right: 16px;
    background: #0a3d62;
    color: white;
    border: none;
    border-radius: 50%;
    width: 32px;
    height: 32px;
    font-weight: 700;
    cursor: pointer;
  }
  /* Buy quantity input */
  #buyQuantity {
    width: 100px;
    padding: 8px 10px;
    margin: 10px 0 15px 0;
    font-size: 1em;
    border-radius: 8px;
    border: 2px solid #0a3d62;
    outline: none;
    transition: border-color 0.3s ease;
  }
  #buyQuantity:focus {
    border-color: #ff9933;
    box-shadow: 0 0 5px #ff9933;
  }
  .error-msg {
    color: #b30000;
    font-weight: 600;
    margin: -10px 0 10px 0;
    font-size: 0.9em;
  }
  /* Buy button */
  #confirmBuyBtn {
    background: linear-gradient(135deg,#138808,#2ecc71);
    border: none;
    padding: 12px 28px;
    border-radius: 14px;
    color: white;
    font-weight: 700;
    font-size: 1em;
    cursor: pointer;
    transition: background 0.25s ease;
  }
  #confirmBuyBtn:hover {
    background: linear-gradient(135deg,#ff9933,#ffd28a);
    color: black;
  }

  /* Confirmation inside popup */
  #confirm-box {
    margin: 15px 0;
    padding: 10px;
    border: 2px solid #138808;
    border-radius: 8px;
    background-color: #e6f4ea;
  }
  #confirm-box p {
    margin: 0 0 10px 0;
  }
  #confirm-box button {
    padding: 8px 16px;
    margin-right: 10px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
  }
  #confirmYesBtn {
    background: #138808;
    color: white;
  }
  #confirmNoBtn {
    background: #b30000;
    color: white;
  }
</style>

</head>
<body>

<div class="top-nav">
  <div class="nav-left" id="navMenu">
    <!-- Nav links will be loaded here -->
  </div>
  <button id="logoutBtn" class="logout-btn">Logout</button>
</div>

<div class="container" id="cropList">
  <!-- Crop cards will be injected here -->
</div>

<!-- Popup -->
<div id="popup">
  <div id="popup-content">
    <button id="popup-close">&times;</button>
    <h2 id="popup-crop-name"></h2>
    <p><strong>Farmer:</strong> <span id="popup-farmer"></span></p>
    <p><strong>Contact:</strong> <span id="popup-contact"></span></p>
    <p><strong>Category:</strong> <span id="popup-category"></span></p>
    <p><strong>Quality:</strong> <span id="popup-quality"></span></p>
    <p><strong>Harvest Date:</strong> <span id="popup-harvest"></span></p>
    <p><strong>Available Until:</strong> <span id="popup-available"></span></p>
    <p><strong>Price per kg:</strong> ₹<span id="popup-price"></span></p>
    <p><strong>Available Quantity:</strong> <span id="popup-quantity"></span> kg</p>
    <p><strong>Min Order Quantity:</strong> <span id="popup-min-quantity"></span> kg</p>
    <p><strong>Location:</strong> <span id="popup-location"></span></p>
    <p><strong>Delivery Type:</strong> <span id="popup-delivery"></span></p>
    <p><strong>Description:</strong> <span id="popup-description"></span></p>

    <label for="buyQuantity">How much do you want to buy? (kg):</label>
    <input type="number" id="buyQuantity" min="1" />
    <div id="error-msg" class="error-msg" style="display:none;"></div>

    <button id="confirmBuyBtn">Confirm Purchase</button>
  </div>
</div>

<script>
const db = window.db;
const loginid = sessionStorage.getItem("loginid");
const usertype = sessionStorage.getItem("usertype");

if (!loginid || (usertype !== "Citizen" && usertype !== "Farmer")) {
  location.href = "login";
}

const navMenu = document.getElementById("navMenu");
const cropList = document.getElementById("cropList");
const popup = document.getElementById("popup");
const popupClose = document.getElementById("popup-close");

let selectedCrop = null;

// Setup nav menu based on usertype
function setupNav() {
  let navHtml = `<a href="Dashboard" class="nav-box">Dashboard</a>`;
  navHtml += `<a href="krishimitr" class="nav-box">Crop Predictor</a>`;
  navHtml += `<a href="Buy" class="nav-box active">Buy Crops</a>`;

  if (usertype === "Farmer") {
    navHtml += `<a href="YourCrops" class="nav-box">Your Crops</a>`;
    navHtml += `<a href="Notification" class="nav-box">Notifications</a>`;
  }
  navMenu.innerHTML = navHtml;
}

async function loadCrops() {
  // Farmer should NOT see their own crops
  const filter = usertype === "Farmer"
    ? db.from('crop_sales').select('*').neq('lid', parseInt(loginid))
    : db.from('crop_sales').select('*');

  const { data, error } = await filter.order('created_at', { ascending: false });

  if (error) {
    cropList.innerHTML = `<p style="color:red;">Error loading crops: ${error.message}</p>`;
    return;
  }

  if (!data || data.length === 0) {
    cropList.innerHTML = "<p>No crops available right now.</p>";
    return;
  }

  cropList.innerHTML = '';

  data.forEach(crop => {
    const card = document.createElement("div");
    card.className = "crop-card";
    card.innerHTML = `
      <div class="crop-title">${crop.crop_name} (${crop.crop_category || "N/A"})</div>
      <div class="crop-details">
        <span>Price:</span> ₹${crop.price} / kg <br>
        <span>Available:</span> ${crop.quantity} kg <br>
        <span>Min Order:</span> ${crop.min_quantity || 1} kg <br>
        <span>Quality:</span> ${crop.quality || "N/A"} <br>
        <span>Location:</span> ${crop.location} <br>
        <span>Delivery:</span> ${crop.delivery_type || "N/A"}
      </div>
    `;

    card.addEventListener("click", () => openPopup(crop));
    cropList.appendChild(card);
  });
}

function openPopup(crop) {
  selectedCrop = crop;
  document.getElementById("popup-crop-name").textContent = crop.crop_name;
  document.getElementById("popup-farmer").textContent = crop.farmer_name;
  document.getElementById("popup-contact").textContent = crop.contact_info || "N/A";
  document.getElementById("popup-category").textContent = crop.crop_category || "N/A";
  document.getElementById("popup-quality").textContent = crop.quality || "N/A";
  document.getElementById("popup-harvest").textContent = crop.harvest_date ? new Date(crop.harvest_date).toLocaleDateString() : "N/A";
  document.getElementById("popup-available").textContent = crop.available_until ? new Date(crop.available_until).toLocaleDateString() : "N/A";
  document.getElementById("popup-price").textContent = crop.price;
  document.getElementById("popup-quantity").textContent = crop.quantity;
  document.getElementById("popup-min-quantity").textContent = crop.min_quantity || 1;
  document.getElementById("popup-location").textContent = crop.location;
  document.getElementById("popup-delivery").textContent = crop.delivery_type || "N/A";
  document.getElementById("popup-description").textContent = crop.description || "None";

  // Reset input and error
  const buyInput = document.getElementById("buyQuantity");
  buyInput.value = "";
  buyInput.min = crop.min_quantity || 1;
  document.getElementById("error-msg").style.display = "none";

  // Remove confirm box if exists
  const confirmBox = document.getElementById("confirm-box");
  if (confirmBox) confirmBox.remove();

  popup.style.display = "flex";
}

popupClose.addEventListener("click", () => {
  closePopupAndReset();
});

document.getElementById("confirmBuyBtn").addEventListener("click", () => {
  const buyInput = document.getElementById("buyQuantity");
  const quantity = parseInt(buyInput.value);

  if (!quantity || quantity < (selectedCrop.min_quantity || 1)) {
    const errorMsg = `Please enter a quantity of at least ${selectedCrop.min_quantity || 1} kg.`;
    const errorDiv = document.getElementById("error-msg");
    errorDiv.textContent = errorMsg;
    errorDiv.style.display = "block";
    return;
  }

  if (quantity > parseInt(selectedCrop.quantity)) {
    const errorMsg = `Cannot buy more than available quantity (${selectedCrop.quantity} kg).`;
    const errorDiv = document.getElementById("error-msg");
    errorDiv.textContent = errorMsg;
    errorDiv.style.display = "block";
    return;
  }

  // Clear error if any
  const errorDiv = document.getElementById("error-msg");
  errorDiv.style.display = "none";

  // Show custom confirmation inside popup
  showConfirmPurchase(quantity);
});

function showConfirmPurchase(quantity) {
  const popupContent = document.getElementById("popup-content");

  // Create confirmation message container if not exists
  let confirmBox = document.getElementById("confirm-box");
  if (!confirmBox) {
    confirmBox = document.createElement("div");
    confirmBox.id = "confirm-box";
    confirmBox.style.margin = "15px 0";
    confirmBox.style.padding = "10px";
    confirmBox.style.border = "2px solid #138808";
    confirmBox.style.borderRadius = "8px";
    confirmBox.style.backgroundColor = "#e6f4ea";
    popupContent.insertBefore(confirmBox, document.getElementById("buyQuantity"));
  }

  confirmBox.innerHTML = `
    <p>Are you sure you want to buy <strong>${quantity} kg</strong> of <strong>${selectedCrop.crop_name}</strong>?</p>
    <button id="confirmYesBtn">Yes</button>
    <button id="confirmNoBtn">No</button>
  `;

  // Disable the main confirm button to prevent double clicks
  document.getElementById("confirmBuyBtn").disabled = true;

  document.getElementById("confirmYesBtn").onclick = async () => {
    // Insert into buy_table
    const { error } = await db.from("buy_table").insert([{
      fname: selectedCrop.farmer_name,
      fid: selectedCrop.lid.toString(),
      cname: selectedCrop.crop_name,
      cid: selectedCrop.jid,
      status: "Pending",
      lid: parseInt(loginid),
      created_at: new Date().toISOString(),
      is_confirmed: false,
      quantity: quantity
    }]);

    if (error) {
      alert(`Failed to place order: ${error.message}`);
      return;
    }

    alert("Purchase request sent! Farmer will confirm soon.");
    closePopupAndReset();
  };

  document.getElementById("confirmNoBtn").onclick = () => {
    // Remove confirmation box and enable confirm button
    confirmBox.remove();
    document.getElementById("confirmBuyBtn").disabled = false;
  };
}

function closePopupAndReset() {
  popup.style.display = "none";
  selectedCrop = null;
  document.getElementById("confirmBuyBtn").disabled = false;
  const confirmBox = document.getElementById("confirm-box");
  if (confirmBox) confirmBox.remove();
  loadCrops();
}

document.getElementById("logoutBtn").onclick = () => {
  sessionStorage.clear();
  location.href = "login";
};

setupNav();
loadCrops();
</script>

</body>
</html>
