<!DOCTYPE html>
<html>
<head>
<title>Buy Crops - Krishi Mitr</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="supabase.js"></script>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
body{
    background: linear-gradient(180deg,#f6e2cc 0%,#f7f9f8 45%,#dceee3 100%);
    font-family: Arial;
    padding-top:100px;
}

.card-custom{
    border-radius:18px;
    padding:20px;
    box-shadow:0 15px 35px rgba(0,0,0,0.15);
    background:white;
}

.buy-btn{
    width:100%;
    background:#0a3d62;
    color:white;
    border:none;
    padding:10px;
    border-radius:10px;
    font-weight:700;
}

.details-box{
    background:#f1f5f9;
    padding:12px;
    border-radius:10px;
    margin-top:10px;
    display:none;
}

.qty-input{
    width:100%;
    padding:8px;
    border-radius:8px;
    border:1px solid #ccc;
}
</style>
</head>

<body>

<div class="container">
<h2 class="text-center mb-4">Available Crops</h2>
<div class="row g-4" id="cropList"></div>
</div>

<script>

const loginid = sessionStorage.getItem("loginid");
const usertype = sessionStorage.getItem("usertype");

if(!loginid || usertype !== "Customer"){
    window.location.href="login";
}

async function loadCrops(){

    const { data:crops, error } = await window.db
        .from("crop_sales")
        .select("*")
        .gt("quantity",0)
        .order("created_at",{ascending:false});

    if(error){
        alert(error.message);
        return;
    }

    const container=document.getElementById("cropList");
    container.innerHTML="";

    if(!crops.length){
        container.innerHTML="<p class='text-center text-muted'>No crops available</p>";
        return;
    }

    crops.forEach(row=>{

        container.innerHTML+=`
        <div class="col-md-4">
            <div class="card-custom">
                <h4>${row.crop_name}</h4>
                <p><b>Price:</b> ₹${row.price}/kg</p>
                <p><b>Available:</b> ${row.quantity} kg</p>
                <p><b>Min Order:</b> ${row.min_quantity || 1} kg</p>
                <p><b>Location:</b> ${row.location}</p>

                <button class="buy-btn" onclick="toggleDetails('${row.jid}')">Buy Now</button>

                <div class="details-box" id="details-${row.jid}">
                    <p><b>Farmer:</b> ${row.farmer_name}</p>
                    <p><b>Quality:</b> ${row.quality || '-'}</p>
                    <p><b>Harvest Date:</b> ${row.harvest_date || '-'}</p>
                    <p><b>Delivery:</b> ${row.delivery_type || '-'}</p>
                    <p><b>Contact:</b> ${row.contact_info || '-'}</p>
                    <p><b>Description:</b> ${row.description || '-'}</p>

                    <input type="number" min="${row.min_quantity || 1}" 
                           max="${row.quantity}" 
                           id="qty-${row.jid}"
                           class="qty-input mt-2"
                           placeholder="Enter quantity in kg">

                    <button class="buy-btn mt-2"
                        onclick="confirmBuy('${row.jid}','${row.crop_name}',
                        '${row.farmer_name}',${row.price},
                        ${row.quantity},${row.min_quantity || 1},
                        ${row.lid})">
                        Confirm Purchase
                    </button>
                </div>
            </div>
        </div>
        `;
    });
}

function toggleDetails(id){
    const box=document.getElementById("details-"+id);
    box.style.display = box.style.display==="block" ? "none":"block";
}

async function confirmBuy(jid,cropName,farmerName,price,availableQty,minQty,lid){

    const qty=document.getElementById("qty-"+jid).value;

    if(!qty || qty<=0){
        alert("Enter valid quantity");
        return;
    }

    if(qty < minQty){
        alert("Minimum order is "+minQty+" kg");
        return;
    }

    if(qty > availableQty){
        alert("Not enough stock available");
        return;
    }

    const total = qty * price;

    if(!confirm(`Confirm buying ${qty} kg of ${cropName} for ₹${total}?`)){
        return;
    }

    const { data:userData } = await window.db
        .from("logindata")
        .select("username")
        .eq("loginid",loginid)
        .maybeSingle();

    const { error:buyError } = await window.db
        .from("buy_table")
        .insert({
            fname: farmerName,
            fid: jid,
            cname: userData?.username || loginid,
            cid: loginid,
            status: "pending",
            lid: lid,
            quantity: qty,
            is_confirmed: false
        });

    if(buyError){
        alert(buyError.message);
        return;
    }

    const newQty = availableQty - qty;

    await window.db
        .from("crop_sales")
        .update({ quantity:newQty })
        .eq("jid",jid);

    alert("Purchase Successful!");

    loadCrops();
}

loadCrops();

</script>

</body>
</html>
