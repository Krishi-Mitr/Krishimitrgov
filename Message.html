<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>New Message</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="supabase.js"></script>
</head>
<body>

<h2>New Message</h2>

<input id="to" placeholder="To (username)">
<div id="suggestions"></div>

<br><br>

<textarea id="message" placeholder="Type message"></textarea>
<br><br>

<button id="sendBtn">Send</button>

<script>

// loginid is STRING in your DB
const loginString = sessionStorage.getItem("loginid");
if(!loginString) location.replace("login");

let myId = null;         // bigint id
let myUsername = null;
let receiverId = null;
let receiverName = null;
let sending = false;

/* LOAD MY USER */
async function loadUser(){
  const { data } = await window.db
    .from("logindata")
    .select("id, username")
    .eq("loginid", loginString)
    .single();

  if(data){
    myId = data.id;
    myUsername = data.username;
  }
}
loadUser();

/* USER SEARCH (NO DUPLICATES) */
const toInput = document.getElementById("to");
const suggestions = document.getElementById("suggestions");

toInput.addEventListener("input", async () => {

  const val = toInput.value.trim();
  suggestions.innerHTML = "";
  receiverId = null;

  if(val.length < 2) return;

  const { data } = await window.db
    .from("logindata")
    .select("id, username")
    .ilike("username", val + "%")
    .limit(10);

  if(!data) return;

  const seen = new Set();

  data.forEach(user => {

    if(user.id === myId) return;
    if(seen.has(user.username)) return;

    seen.add(user.username);

    const div = document.createElement("div");
    div.textContent = user.username;
    div.style.cursor = "pointer";

    div.onclick = () => {
      receiverId = user.id;
      receiverName = user.username;
      toInput.value = user.username;
      suggestions.innerHTML = "";
    };

    suggestions.appendChild(div);
  });

});

/* SEND MESSAGE */
document.getElementById("sendBtn").addEventListener("click", sendMessage);

async function sendMessage(){

  if(sending) return;
  sending = true;

  const text = document.getElementById("message").value.trim();
  if(!receiverId || !text){
    alert("Fill all fields");
    sending = false;
    return;
  }

  // CHECK EXISTING CHAT
  const { data: existing } = await window.db
    .from("chat_conversations")
    .select("*")
    .or(`and(user1id.eq.${myId},user2id.eq.${receiverId}),and(user1id.eq.${receiverId},user2id.eq.${myId})`)
    .maybeSingle();

  let chatId;

  if(existing){

    chatId = existing.chatid;

    await window.db
      .from("chat_conversations")
      .update({
        last_message: text,
        last_time: new Date(),
        unread_for: receiverId
      })
      .eq("chatid", chatId);

  } else {

    const { data } = await window.db
      .from("chat_conversations")
      .insert([{
        user1id: myId,
        user2id: receiverId,
        user1name: myUsername,
        user2name: receiverName,
        last_message: text,
        unread_for: receiverId
      }])
      .select()
      .single();

    chatId = data.chatid;
  }

  // INSERT MESSAGE
  await window.db
    .from("chat_messages")
    .insert([{
      chatid: chatId,
      senderid: myId,
      sendername: myUsername,
      message: text
    }]);

  location.href = "chat?chatid=" + chatId;
}

</script>
</body>
</html>
