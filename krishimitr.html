<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>KrishiMitra ‚Äî Local Crop Market Predictor & Crop Advisor</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="supabase.js"></script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800;900&display=swap');

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  background: linear-gradient(135deg, #FF9933 0%, #FFFFFF 30%, #FFFFFF 70%, #138808 100%);
  background-attachment: fixed;
  background-size: 200% 200%;
  animation: gradientShift 15s ease infinite;
  font-family: 'Poppins', sans-serif;
  margin: 0;
  padding-top: 90px;
  min-height: 100vh;
  position: relative;
  overflow-x: hidden;
}

@keyframes gradientShift {
  0% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}

/* Animated background elements */
body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: radial-gradient(circle at 20% 50%, rgba(255, 153, 51, 0.1) 0%, transparent 50%),
              radial-gradient(circle at 80% 50%, rgba(19, 136, 8, 0.1) 0%, transparent 50%);
  pointer-events: none;
  z-index: 0;
  animation: float 20s ease-in-out infinite;
}

@keyframes float {
  0%, 100% { transform: translateY(0px) rotate(0deg); }
  50% { transform: translateY(-20px) rotate(5deg); }
}

.top-navbar {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 15px 30px;
  background: linear-gradient(90deg, #FF9933 0%, #FFFFFF 30%, #FFFFFF 70%, #138808 100%);
  border-bottom: 4px solid #000080;
  z-index: 1000;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
  backdrop-filter: blur(10px);
  animation: slideDown 0.5s ease-out;
}

@keyframes slideDown {
  from {
    transform: translateY(-100%);
    opacity: 0;
  }
  to {
    transform: translateY(0);
    opacity: 1;
  }
}

.brand {
  font-size: 28px;
  font-weight: 900;
  color: #000080;
  text-shadow: 2px 2px 4px rgba(255, 255, 255, 0.5);
  animation: pulse 2s ease-in-out infinite;
  letter-spacing: 1px;
}

@keyframes pulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.05); }
}

.nav-center {
  display: flex;
  gap: 20px;
  flex-wrap: wrap;
}

.nav-link-custom {
  text-decoration: none;
  padding: 10px 20px;
  border-radius: 25px;
  font-weight: 600;
  color: #000080;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
  background: rgba(255, 255, 255, 0.3);
  backdrop-filter: blur(5px);
}

.nav-link-custom::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.5), transparent);
  transition: left 0.5s;
}

.nav-link-custom:hover::before {
  left: 100%;
}

.nav-link-custom:hover {
  background: rgba(0, 0, 128, 0.15);
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 128, 0.2);
}

.nav-right {
  display: flex;
  gap: 15px;
  align-items: center;
}

.logout-btn {
  padding: 10px 20px;
  background: linear-gradient(135deg, #000080, #1a1a8a);
  color: white;
  border-radius: 25px;
  font-weight: 700;
  text-decoration: none;
  border: none;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 4px 15px rgba(0, 0, 128, 0.3);
}

.logout-btn:hover {
  background: linear-gradient(135deg, #FF9933, #ffaa44);
  color: #000;
  transform: translateY(-2px) scale(1.05);
  box-shadow: 0 6px 20px rgba(255, 153, 51, 0.4);
}

.container {
  max-width: 1400px;
  margin: 0 auto;
  padding: 30px 20px;
  position: relative;
  z-index: 1;
}

.card {
  background: rgba(255, 255, 255, 0.95);
  padding: 30px;
  border-radius: 20px;
  margin-bottom: 25px;
  box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
  border: 3px solid transparent;
  background-clip: padding-box;
  position: relative;
  overflow: hidden;
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  animation: fadeInUp 0.6s ease-out backwards;
}

@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(30px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 5px;
  background: linear-gradient(90deg, #FF9933, #FFFFFF, #138808);
  opacity: 0;
  transition: opacity 0.3s;
}

.card:hover::before {
  opacity: 1;
}

.card:hover {
  transform: translateY(-5px);
  box-shadow: 0 12px 40px rgba(0, 0, 0, 0.2);
  border-color: #000080;
}

.card:nth-child(1) { animation-delay: 0.1s; }
.card:nth-child(2) { animation-delay: 0.2s; }
.card:nth-child(3) { animation-delay: 0.3s; }
.card:nth-child(4) { animation-delay: 0.4s; }

.form-group {
  margin-bottom: 20px;
  animation: fadeIn 0.5s ease-out;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.form-group label {
  display: block;
  margin-bottom: 8px;
  font-weight: 600;
  color: #000080;
  font-size: 15px;
  letter-spacing: 0.5px;
}

.form-control {
  width: 100%;
  padding: 12px 15px;
  border: 2px solid #e0e0e0;
  border-radius: 12px;
  font-size: 15px;
  transition: all 0.3s ease;
  background: white;
  font-family: 'Poppins', sans-serif;
}

.form-control:focus {
  outline: none;
  border-color: #000080;
  box-shadow: 0 0 0 4px rgba(0, 0, 128, 0.1);
  transform: translateY(-2px);
}

input[type="range"] {
  width: 100%;
  height: 8px;
  border-radius: 5px;
  background: linear-gradient(to right, #FF9933, #FFFFFF, #138808);
  outline: none;
  -webkit-appearance: none;
  appearance: none;
}

input[type="range"]::-webkit-slider-thumb {
  -webkit-appearance: none;
  appearance: none;
  width: 20px;
  height: 20px;
  border-radius: 50%;
  background: #000080;
  cursor: pointer;
  box-shadow: 0 2px 10px rgba(0, 0, 128, 0.3);
  transition: all 0.3s ease;
}

input[type="range"]::-moz-range-thumb {
  appearance: none;
  -moz-appearance: none;
  width: 20px;
  height: 20px;
  border-radius: 50%;
  background: #000080;
  cursor: pointer;
  box-shadow: 0 2px 10px rgba(0, 0, 128, 0.3);
  transition: all 0.3s ease;
  border: none;
}

input[type="range"]::-webkit-slider-thumb:hover {
  transform: scale(1.2);
  box-shadow: 0 4px 15px rgba(0, 0, 128, 0.5);
}

.btn {
  padding: 12px 25px;
  border: none;
  border-radius: 12px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  font-size: 15px;
  font-family: 'Poppins', sans-serif;
  position: relative;
  overflow: hidden;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.btn::before {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 0;
  height: 0;
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.3);
  transform: translate(-50%, -50%);
  transition: width 0.6s, height 0.6s;
}

.btn:hover::before {
  width: 300px;
  height: 300px;
}

.btn:active {
  transform: scale(0.98);
}

.btn-primary {
  background: linear-gradient(135deg, #000080, #1a1a8a);
  color: white;
  box-shadow: 0 4px 15px rgba(0, 0, 128, 0.3);
}

.btn-primary:hover {
  background: linear-gradient(135deg, #FF9933, #ffaa44);
  color: #000;
  transform: translateY(-3px);
  box-shadow: 0 6px 20px rgba(255, 153, 51, 0.4);
}

.btn-success {
  background: linear-gradient(135deg, #138808, #16a309);
  color: white;
  box-shadow: 0 4px 15px rgba(19, 136, 8, 0.3);
}

.btn-success:hover {
  background: linear-gradient(135deg, #0d6e05, #0f7f06);
  transform: translateY(-3px);
  box-shadow: 0 6px 20px rgba(19, 136, 8, 0.4);
}

.btn-info {
  background: linear-gradient(135deg, #0dcaf0, #0bb5d6);
  color: #000;
  box-shadow: 0 4px 15px rgba(13, 202, 240, 0.3);
}

.btn-info:hover {
  background: linear-gradient(135deg, #0aa2c0, #098ba8);
  transform: translateY(-3px);
  box-shadow: 0 6px 20px rgba(13, 202, 240, 0.4);
}

.btn-warning {
  background: linear-gradient(135deg, #ffc107, #ffcd39);
  color: #000;
  box-shadow: 0 4px 15px rgba(255, 193, 7, 0.3);
}

.btn-warning:hover {
  background: linear-gradient(135deg, #ffb300, #ffc107);
  transform: translateY(-3px);
  box-shadow: 0 6px 20px rgba(255, 193, 7, 0.4);
}

.chart-container {
  position: relative;
  height: 400px;
  margin: 20px 0;
  animation: fadeIn 0.8s ease-out;
}

.recommend {
  font-size: 20px;
  font-weight: 700;
  color: #000080;
  margin-bottom: 15px;
  padding: 10px;
  background: linear-gradient(90deg, rgba(255, 153, 51, 0.1), rgba(19, 136, 8, 0.1));
  border-radius: 10px;
  border-left: 4px solid #000080;
  animation: slideInLeft 0.5s ease-out;
}

@keyframes slideInLeft {
  from {
    opacity: 0;
    transform: translateX(-30px);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

#actionCard {
  margin-top: 20px;
}

.row {
  display: flex;
  gap: 25px;
  flex-wrap: wrap;
}

.col-md-6 {
  flex: 1;
  min-width: 320px;
  animation: fadeInUp 0.6s ease-out backwards;
}

.text-success {
  color: #138808;
  font-weight: 600;
}

.text-danger {
  color: #dc3545;
  font-weight: 600;
}

.text-warning {
  color: #ff9800;
  font-weight: 600;
}

.text-info {
  color: #0dcaf0;
  font-weight: 600;
}

.small-muted {
  font-size: 13px;
  color: #666;
}

.mt-2 {
  margin-top: 15px;
}

.mt-3 {
  margin-top: 20px;
}

.mb-3 {
  margin-bottom: 20px;
}

#qrCanvas {
  margin-top: 15px;
  border: 3px solid #000080;
  border-radius: 12px;
  padding: 10px;
  background: white;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
  transition: transform 0.3s ease;
}

#qrCanvas:hover {
  transform: scale(1.05);
}

body.dark {
  background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 50%, #1a1a1a 100%);
  color: #fff;
}

body.dark .card {
  background: rgba(45, 45, 45, 0.95);
  color: #fff;
  border-color: #555;
}

body.dark .form-control {
  background: #333;
  color: #fff;
  border-color: #555;
}

body.dark .form-control:focus {
  border-color: #FF9933;
  box-shadow: 0 0 0 4px rgba(255, 153, 51, 0.2);
}

.w-100 {
  width: 100%;
}

h2, h4 {
  color: #000080;
  margin-bottom: 20px;
  font-weight: 700;
  letter-spacing: 0.5px;
}

h2 {
  font-size: 32px;
  background: linear-gradient(90deg, #FF9933, #000080, #138808);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  animation: gradientText 3s ease infinite;
}

@keyframes gradientText {
  0%, 100% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
}

body.dark h2, body.dark h4 {
  color: #fff;
}

#mainApp {
  display: block;
}

/* Loading animation */
@keyframes spin {
  to { transform: rotate(360deg); }
}

.loading {
  display: inline-block;
  width: 20px;
  height: 20px;
  border: 3px solid rgba(255, 255, 255, 0.3);
  border-radius: 50%;
  border-top-color: white;
  animation: spin 1s linear infinite;
}

/* Responsive design */
@media (max-width: 768px) {
  .top-navbar {
    flex-direction: column;
    padding: 15px;
    gap: 15px;
  }
  
  .nav-center {
    flex-direction: column;
    width: 100%;
    gap: 10px;
  }
  
  .nav-link-custom {
    width: 100%;
    text-align: center;
  }
  
  .brand {
    font-size: 22px;
  }
  
  body {
    padding-top: 150px;
  }
  
  .card {
    padding: 20px;
  }
  
  h2 {
    font-size: 24px;
  }
}

/* Smooth scroll */
html {
  scroll-behavior: smooth;
}

/* Button loading state */
.btn.loading {
  pointer-events: none;
  opacity: 0.7;
}

/* Card entrance animations */
@keyframes cardEntrance {
  from {
    opacity: 0;
    transform: scale(0.9) translateY(20px);
  }
  to {
    opacity: 1;
    transform: scale(1) translateY(0);
  }
}

.card {
  animation: cardEntrance 0.5s ease-out backwards;
}
</style>
</head>

<body>

<div class="top-navbar">
  <div class="brand">üåæ KrishiMitra AI</div>

  <div class="nav-center" id="navCenter">
    <a href="Dashboard.html" class="nav-link-custom">Main Page</a>
    <a href="Notification.html" class="nav-link-custom farmer-only">Notification</a>
    <a href="Sell.html" class="nav-link-custom farmer-only">Sell Crops</a>
    <a href="Buy.html" class="nav-link-custom">Buy Crops</a>
  </div>

  <div class="nav-right">
    <button id="toggleDark" class="btn btn-light btn-sm" style="background: rgba(255,255,255,0.3); backdrop-filter: blur(5px); border: 2px solid rgba(0,0,128,0.3); color: #000080; font-weight: 600; padding: 8px 16px; border-radius: 20px; transition: all 0.3s ease;">üåô Dark Mode</button>
    <a href="#" id="logoutBtn" class="logout-btn">Logout</a>
  </div>
</div>

<div id="mainApp">
  <div class="container">
    
    <div class="card" style="text-align: center; background: linear-gradient(135deg, rgba(255, 153, 51, 0.1), rgba(255, 255, 255, 0.95), rgba(19, 136, 8, 0.1)); border: 3px solid #000080;">
      <h2 style="margin-bottom: 15px;">üåæ Crop Price Predictor & Advisor</h2>
      <p style="font-size: 18px; color: #333; font-weight: 500; margin-bottom: 0;">Get intelligent price forecasts and expert farming advice for your crops</p>
      <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
        <span style="padding: 5px 15px; background: rgba(255, 153, 51, 0.2); border-radius: 20px; font-size: 13px; font-weight: 600; color: #000080;">üìä Real-time Predictions</span>
        <span style="padding: 5px 15px; background: rgba(19, 136, 8, 0.2); border-radius: 20px; font-size: 13px; font-weight: 600; color: #000080;">üí° Expert Advice</span>
        <span style="padding: 5px 15px; background: rgba(0, 0, 128, 0.2); border-radius: 20px; font-size: 13px; font-weight: 600; color: #000080;">üìà Market Trends</span>
      </div>
    </div>

    <div class="row">
      <div class="col-md-6">
        <div class="card">
          <h4>Price Prediction</h4>
          
          <div class="form-group">
            <label for="cropSelect">Select Crop</label>
            <select id="cropSelect" class="form-control">
              <option value="Wheat">Wheat</option>
              <option value="Rice">Rice</option>
              <option value="Sugarcane">Sugarcane</option>
              <option value="Cotton">Cotton</option>
              <option value="Maize">Maize</option>
              <option value="Sorghum">Sorghum</option>
              <option value="Barley">Barley</option>
              <option value="Millet">Millet</option>
              <option value="Soybean">Soybean</option>
              <option value="Groundnut">Groundnut</option>
              <option value="Tomato">Tomato</option>
              <option value="Potato">Potato</option>
            </select>
          </div>

          <div class="form-group">
            <label for="regionSelect">Select Region</label>
            <select id="regionSelect" class="form-control">
              <option value="Punjab">Punjab</option>
              <option value="Haryana">Haryana</option>
              <option value="Uttar Pradesh">Uttar Pradesh</option>
              <option value="Maharashtra">Maharashtra</option>
              <option value="Karnataka">Karnataka</option>
              <option value="Tamil Nadu">Tamil Nadu</option>
              <option value="Gujarat">Gujarat</option>
              <option value="Rajasthan">Rajasthan</option>
            </select>
          </div>

          <div class="form-group">
            <label>Forecast Horizon: <span id="hval">30</span> days</label>
            <input type="range" id="horizon" class="form-control" min="7" max="90" value="30">
          </div>

          <button id="predictBtn" class="btn btn-primary w-100">Predict Prices</button>
          <button id="combineBtn" class="btn btn-warning w-100 mt-2">Predict + Get Advice</button>
          <button id="exportBtn" class="btn btn-info w-100 mt-2">Export CSV</button>
          <button id="voiceBtn" class="btn btn-success w-100 mt-2">üé§ Voice Input</button>
        </div>

        <div class="card">
          <h4>Crop Advisor</h4>
          
          <div class="form-group">
            <label for="soilType">Soil Type</label>
            <select id="soilType" class="form-control">
              <option value="Loamy">Loamy</option>
              <option value="Clayey">Clayey</option>
              <option value="Sandy">Sandy</option>
              <option value="Silty">Silty</option>
            </select>
          </div>

          <div class="form-group">
            <label for="rainfall">Expected Rainfall (mm)</label>
            <input type="number" id="rainfall" class="form-control" value="200" min="0" max="1000">
          </div>

          <div class="form-group">
            <label for="temp">Expected Temperature (¬∞C)</label>
            <input type="number" id="temp" class="form-control" value="25" min="-10" max="50">
          </div>

          <button id="adviseBtn" class="btn btn-success w-100">Get Farming Advice</button>
        </div>
      </div>

      <div class="col-md-6">
        <div class="card">
          <h4>Price Chart</h4>
          <div class="chart-container">
            <canvas id="priceChart"></canvas>
          </div>
        </div>

        <div class="card">
          <h4>Recommendations</h4>
          <div id="actionCard">
            <p class="text-muted">Run a prediction to see recommendations</p>
          </div>
        </div>

        <div class="card">
          <h4>Advisor Output</h4>
          <div id="advisorOutput" class="text-muted">
            Get farming advice by clicking "Get Farming Advice"
          </div>
        </div>

        <div class="card">
          <h4>Share App</h4>
          <canvas id="qrCanvas"></canvas>
        </div>
      </div>
    </div>

  </div>
</div>

<script>
// Check authentication - anyone logged in (Farmer or Citizen) can access this page
// Use retry mechanism to handle navbar navigation timing issues
(function() {
    let retryCount = 0;
    const MAX_RETRIES = 10;
    
    function checkAuth() {
        try {
            const loginid = sessionStorage.getItem("loginid");
            const usertype = sessionStorage.getItem("usertype");
            
            if (loginid && usertype) {
                console.log("‚úÖ Authentication passed");
                return; // Success, stop checking
            }
        } catch (e) {
            console.log("SessionStorage access error, retrying...", e);
        }
        
        // Retry if credentials not found yet (handles navbar navigation timing)
        if (retryCount < MAX_RETRIES) {
            retryCount++;
            setTimeout(checkAuth, 50);
        } else {
            // After all retries, redirect if still no credentials
            console.error("‚ùå Redirecting to login - no credentials found after retries");
            window.location.href = "login.html";
        }
    }
    
    // Start check with a small initial delay to ensure sessionStorage is ready
    setTimeout(checkAuth, 10);
})();

// Wait for DOM to be ready before manipulating elements
function setupPage() {
    // Get usertype from sessionStorage when needed
    const currentUsertype = sessionStorage.getItem("usertype");
    
    // Hide farmer-only navigation links if user is not a farmer (but they can still use the page)
    if (currentUsertype && currentUsertype !== "Farmer") {
        try {
            document.querySelectorAll('.farmer-only').forEach(el => el.remove());
        } catch (e) {
            // Elements might not exist yet, try again later
            setTimeout(() => {
                document.querySelectorAll('.farmer-only').forEach(el => el.remove());
            }, 100);
        }
    }

    // Setup logout button
    const logoutBtn = document.getElementById('logoutBtn');
    if (logoutBtn) {
        logoutBtn.onclick = () => {
            sessionStorage.clear();
            location.href = "login.html";
        };
    } else {
        // Retry if button doesn't exist yet
        setTimeout(setupPage, 50);
    }
}

// Run setup when DOM is ready
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', setupPage);
} else {
    setupPage();
}
</script>

<script>
const backBtn = document.getElementById('backBtn');
if (backBtn) {
  backBtn.addEventListener('click', ()=> {
    window.scrollTo({top: 0, behavior: 'smooth'});
  });
}

const toggleBtn = document.getElementById('toggleDark');
if (toggleBtn) {
  toggleBtn.addEventListener('click', () => {
    document.body.classList.toggle('dark');
    toggleBtn.innerText = document.body.classList.contains('dark') ? '‚òÄÔ∏è Light Mode' : 'üåô Dark Mode';
    // Add smooth transition
    document.body.style.transition = 'background 0.5s ease, color 0.5s ease';
    setTimeout(() => {
      document.body.style.transition = '';
    }, 500);
  });
  
  // Add hover effect
  toggleBtn.addEventListener('mouseenter', () => {
    toggleBtn.style.transform = 'scale(1.1)';
    toggleBtn.style.boxShadow = '0 4px 15px rgba(0, 0, 128, 0.3)';
  });
  
  toggleBtn.addEventListener('mouseleave', () => {
    toggleBtn.style.transform = 'scale(1)';
    toggleBtn.style.boxShadow = 'none';
  });
}




const cropBase = {
  Wheat:2000, Rice:2100, Sugarcane:1800, Cotton:2300,
  Maize:1600, Sorghum:1500, Barley:1400, Millet:1300,
  Soybean:1700, Groundnut:1600, Tomato:2000, Potato:1900
};
const volatility = {
  Wheat:12, Rice:15, Sugarcane:10, Cotton:18,
  Maize:14, Sorghum:13, Barley:11, Millet:10,
  Soybean:15, Groundnut:12, Tomato:18, Potato:16
};


function genHistorical(crop, region){
  const days = 90;
  const base = cropBase[crop] || 2000;
  const vol = volatility[crop] || 12;
  const arr = [];

  let p = base + (Math.random()-0.5)*40;
  for(let i = days; i > 0; i--){
 
    const seasonal = Math.sin(i/7)*8;
    const regionBias = (region ? (region.length % 5) - 2 : 0) * 0.6;
    const noise = (Math.random()-0.5) * vol;
    p = Math.max(50, p + seasonal + noise + regionBias);
    const d = new Date();
    d.setDate(d.getDate() - i);
    arr.push({date: d.toISOString().slice(0,10), price: Math.round(p*10)/10});
  }
  return arr;
}

function forecastPrices(hist, days, crop, scenario = 0){
  if(!hist || !hist.length) return [];
  const vol = volatility[crop] || 12;
  const last = hist[hist.length-1].price;
  const first = hist[0].price;
  const slope = (last - first) / Math.max(1, (hist.length-1)); // per-day slope
  const preds = [];
  let p = last;
  for(let i=1;i<=days;i++){
    // scenario can be -1,0,1 for bad/neutral/good (or a small multiplier)
    const noise = (Math.random()-0.5) * vol;
    const shock = scenario * (Math.random()-0.4) * vol * 1.8;
    // small decaying seasonal influence
    const seasonal = Math.sin((i+hist.length)/7) * 6;
    p = Math.max(20, p + slope*0.6 + noise + shock + seasonal*0.3);
    const d = new Date();
    d.setDate(new Date().getDate() + i);
    preds.push({date: d.toISOString().slice(0,10), price: Math.round(p*10)/10});
  }
  return preds;
}

let priceChart = null;

function initChart() {
  const chartEl = document.getElementById('priceChart');
  if (!chartEl) {
    setTimeout(initChart, 100);
    return;
  }
  const chartCtx = chartEl.getContext('2d');
  priceChart = new Chart(chartCtx, {
    type: 'line',
    data: { labels: [], datasets: [] },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      animation: {
        duration: 1500,
        easing: 'easeInOutQuart'
      },
      interaction: { 
        mode: 'index', 
        intersect: false 
      },
      plugins: { 
        legend: { 
          position: 'top',
          labels: {
            font: {
              family: 'Poppins',
              size: 14,
              weight: '600'
            },
            padding: 15,
            usePointStyle: true
          }
        },
        tooltip: {
          backgroundColor: 'rgba(0, 0, 0, 0.8)',
          padding: 12,
          titleFont: {
            family: 'Poppins',
            size: 14,
            weight: '600'
          },
          bodyFont: {
            family: 'Poppins',
            size: 13
          },
          borderColor: '#000080',
          borderWidth: 2,
          cornerRadius: 8
        }
      },
      scales: {
        x: { 
          display: true,
          grid: {
            color: 'rgba(0, 0, 128, 0.1)'
          },
          ticks: {
            font: {
              family: 'Poppins',
              size: 12
            }
          }
        },
        y: { 
          display: true, 
          title: { 
            display: true, 
            text: 'Price (‚Çπ/qtl)',
            font: {
              family: 'Poppins',
              size: 14,
              weight: '600'
            },
            color: '#000080'
          },
          grid: {
            color: 'rgba(0, 0, 128, 0.1)'
          },
          ticks: {
            font: {
              family: 'Poppins',
              size: 12
            }
          }
        }
      }
    }
  });
}

function updateChart(hist, preds){
  if (!priceChart) {
    initChart();
    setTimeout(() => updateChart(hist, preds), 200);
    return;
  }
  const histDates = hist.map(h => h.date);
  const predDates = preds.map(p => p.date);
  const labels = histDates.concat(predDates);

  const histData = hist.map(h => h.price).concat(new Array(preds.length).fill(null));
  const predData = new Array(Math.max(0, hist.length-1)).fill(null)
                     .concat([hist[hist.length-1].price])
                     .concat(preds.map(p => p.price));

  if(histData.length !== labels.length || predData.length !== labels.length){

    const L = labels.length;
    while(histData.length < L) histData.push(null);
    while(predData.length < L) predData.unshift(null);
    histData.length = predData.length = labels.length;
  }

  priceChart.data.labels = labels;
  priceChart.data.datasets = [
    {
      label: 'Historical',
      data: histData,
      borderWidth: 3,
      tension: 0.4,
      pointRadius: 4,
      pointHoverRadius: 6,
      borderColor: '#000080',
      backgroundColor: 'rgba(0, 0, 128, 0.1)',
      fill: true,
      pointBackgroundColor: '#000080',
      pointBorderColor: '#FFFFFF',
      pointBorderWidth: 2
    },
    {
      label: 'Forecast',
      data: predData,
      borderDash: [8, 4],
      borderWidth: 3,
      tension: 0.4,
      pointRadius: 4,
      pointHoverRadius: 6,
      borderColor: '#138808',
      backgroundColor: 'rgba(19, 136, 8, 0.1)',
      fill: true,
      pointBackgroundColor: '#138808',
      pointBorderColor: '#FFFFFF',
      pointBorderWidth: 2
    }
  ];
  priceChart.update();
}

function setupEventListeners() {
  const hval = document.getElementById('hval');
  const hor = document.getElementById('horizon');
  if (hval && hor) {
    hor.addEventListener('input', ()=> hval.innerText = hor.value);
  }

  const predictBtn = document.getElementById('predictBtn');
  const adviseBtn = document.getElementById('adviseBtn');
  const combineBtn = document.getElementById('combineBtn');
  const exportBtn = document.getElementById('exportBtn');
  const voiceBtn = document.getElementById('voiceBtn');

  if (predictBtn) predictBtn.addEventListener('click', ()=> { runPrediction(false); });
  if (adviseBtn) adviseBtn.addEventListener('click', ()=> { runAdvisor(false); });
  if (combineBtn) combineBtn.addEventListener('click', ()=> { runPrediction(true); });
  if (exportBtn) exportBtn.addEventListener('click', exportCSV);
  if (voiceBtn) voiceBtn.addEventListener('click', voiceInput);
}

let lastForecast = [];
let lastCrop = 'Wheat';
let lastRegion = 'Punjab';

function runPrediction(runAdvisorToo){
  const predictBtn = document.getElementById('predictBtn');
  const combineBtn = document.getElementById('combineBtn');
  const btn = runAdvisorToo ? combineBtn : predictBtn;
  
  // Add loading state
  if (btn) {
    const originalText = btn.innerHTML;
    btn.innerHTML = '<span class="loading"></span> Processing...';
    btn.classList.add('loading');
    btn.disabled = true;
  }
  
  // Simulate processing delay for better UX
  setTimeout(() => {
    const crop = document.getElementById('cropSelect').value;
    const region = document.getElementById('regionSelect').value;
    const days = parseInt(document.getElementById('horizon').value, 10);
    const hist = genHistorical(crop, region);
    const scenario = 0; // neutral demo
    const preds = forecastPrices(hist, days, crop, scenario);

    updateChart(hist, preds);
    lastForecast = preds;
    lastCrop = crop;
    lastRegion = region;

    const now = hist[hist.length-1].price;
    const futureAvg = preds.length ? preds.reduce((s,p)=>s+p.price,0)/preds.length : now;
    const changePct = ((futureAvg - now)/Math.max(1, now))*100;

    const actionCard = document.getElementById('actionCard');
    let html = `<div><div class="recommend">üìä Avg change: ${changePct.toFixed(1)}% over next ${days} days</div>`;
    if(changePct > 4){
      html += `<div class="mt-2 text-success" style="animation: fadeIn 0.5s ease-out;">üåü Tip: Prices look like they will go <strong>up</strong>. Consider storing a bit and selling later.</div>`;
    } else if(changePct < -4){
      html += `<div class="mt-2 text-danger" style="animation: fadeIn 0.5s ease-out;">‚ö†Ô∏è Tip: Prices may go <strong>down</strong>. Consider selling soon.</div>`;
    } else {
      html += `<div class="mt-2 text-warning" style="animation: fadeIn 0.5s ease-out;">üí° Tip: Prices should stay about the same. You can sell some now and keep some.</div>`;
    }
    html += `<div class="mt-2 small-muted"></div>`;
    html += `<div id="advisorTipSlot"></div></div>`;
    actionCard.innerHTML = html;
    actionCard.style.animation = 'fadeInUp 0.5s ease-out';

    // Remove loading state
    if (btn) {
      btn.innerHTML = originalText;
      btn.classList.remove('loading');
      btn.disabled = false;
    }

    if(runAdvisorToo) runAdvisor(true);
  }, 800);
}


function runAdvisor(showOnRight){
  const adviseBtn = document.getElementById('adviseBtn');
  
  // Add loading state if not called from combine
  if (adviseBtn && !showOnRight) {
    const originalText = adviseBtn.innerHTML;
    adviseBtn.innerHTML = '<span class="loading"></span> Analyzing...';
    adviseBtn.classList.add('loading');
    adviseBtn.disabled = true;
  }
  
  // Simulate processing delay for better UX
  setTimeout(() => {
    const soil = document.getElementById('soilType').value;
    const rain = parseFloat(document.getElementById('rainfall').value);
    const temp = parseFloat(document.getElementById('temp').value);
    const crop = document.getElementById('cropSelect').value;

    const seedOptions = {
      Rice:['Local high-yield rice','Flood-tolerant rice','Short-duration rice'],
      Wheat:['Drought-tolerant wheat','Early-maturity wheat','High-protein wheat'],
      Cotton:['Bt cotton (local)','Organic cotton','Short-staple cotton'],
      Maize:['Hybrid maize','Sweet corn variety','High-yield maize'],
      Sorghum:['Local millets mix','Drought-resilient sorghum','Red sorghum'],
      Barley:['Certified barley','Malting barley','Hull-less barley'],
      Millet:['Millet seeds mix','Finger millet','Foxtail millet'],
      Soybean:['Local soybean','Early-maturing soybean','High-protein soybean'],
      Groundnut:['Groundnut seeds','Spanish variety','Virginia variety'],
      Tomato:['Tomato seeds','Cherry tomato','Disease-resistant tomato'],
      Potato:['Potato seeds','Early variety','High-starch variety'],
      Sugarcane:['High-yield sugarcane','Disease-resistant cane','Early-maturity cane']
    };
    const fertOptions = {
      Rice:['Urea + SSP','NPK 12-32-16','Compost-enriched'],
      Wheat:['NPK 10-26-26','Urea top-dressing','Organic mix'],
      Cotton:['Potash-rich','NPK 12-12-17','Biofertilizer'],
      Maize:['Balanced NPK','Compost+urea','Liquid fertilizer mix'],
      Sorghum:['NPK 12-24-12','Organic compost','Urea split'],
      Barley:['NPK 10-10-10','Farmyard manure','Micronutrient mix'],
      Millet:['Organic compost','NPK 8-20-10','Green manure'],
      Soybean:['NPK 12-12-12','Rhizobium inoculant','Balanced compost'],
      Groundnut:['Potash-rich','NPK 10-20-10','FYM+Biofertilizer'],
      Tomato:['NPK 10-10-10','Organic mix','Liquid foliar fertilizer'],
      Potato:['Balanced NPK','FYM + urea','Potassium-rich fertilizer'],
      Sugarcane:['NPK 14-14-14','Compost enriched','Micronutrient mix']
    };

    function pickRandom(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
    const seed = pickRandom(seedOptions[crop] || ['Local seeds']);
    const fert = pickRandom(fertOptions[crop] || ['Balanced fertilizer']);

    let weatherAdvice = '';
    if(rain < 50) weatherAdvice += 'Low rainfall expected; consider drought-tolerant varieties and water-saving practices. ';
    else if(rain > 400) weatherAdvice += 'High rainfall expected; ensure drainage and flood-tolerant varieties. ';

    if(temp > 35) weatherAdvice += 'High temperatures ‚Äî shade and irrigation recommended. ';
    else if(temp < 10) weatherAdvice += 'Low temperature ‚Äî consider frost protection and early maturing varieties. ';

    const advice = `üí° Advisor Tip for ${crop}: Soil: ${soil}, Rainfall: ${rain}mm, Temp: ${temp}¬∞C. ${weatherAdvice}Recommended Seed: ${seed}. Recommended Fertilizer: ${fert}. Monitor local weather and pest alerts.`;

    const advisorOutput = document.getElementById('advisorOutput');
    advisorOutput.innerHTML = `<div style="animation: fadeIn 0.5s ease-out;">${advice}</div>`;
    advisorOutput.style.animation = 'fadeInUp 0.5s ease-out';
    
    if(showOnRight){
      const slot = document.getElementById('advisorTipSlot');
      if(slot){
        slot.innerHTML = `<div class="mt-2 text-info small" id="advisorTip" style="animation: fadeIn 0.5s ease-out;">${advice.replace(/\n/g,'<br>')}</div>`;
      } else {
        const actionCard = document.getElementById('actionCard');
        const tipDiv = document.createElement('div');
        tipDiv.id = 'advisorTip';
        tipDiv.className = 'mt-2 text-info small';
        tipDiv.style.animation = 'fadeIn 0.5s ease-out';
        tipDiv.innerHTML = advice.replace(/\n/g,'<br>');
        actionCard.appendChild(tipDiv);
      }
    }
    
    // Remove loading state
    if (adviseBtn && !showOnRight) {
      adviseBtn.innerHTML = originalText;
      adviseBtn.classList.remove('loading');
      adviseBtn.disabled = false;
    }
  }, 600);
}

function exportCSV(){
  if(!lastForecast || !lastForecast.length){
    alert('Run a prediction first');
    return;
  }
  let csv = 'Date,Price (‚Çπ/qtl)\n';
  lastForecast.forEach(r => { csv += `${r.date},${r.price}\n`; });
  const blob = new Blob([csv], {type: 'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;

  const fname = `${(lastCrop||'crop')}_${(lastRegion||'region')}_forecast.csv`.replace(/\s+/g,'_');
  a.download = fname;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

function generateQR(){
  const canvas = document.getElementById('qrCanvas');

  const url = 'https://krishimitr8c.netlify.app';

  try{
    QRCode.toCanvas(canvas, url, { width: 120 }, function (error) {
      if (error) console.error('QR error', error);
    });
  } catch(e){
    console.error('QRCode error', e);
  }
}

function voiceInput(){
  alert('Voice input not implemented in this demo.');
}

// Initialize when DOM is ready
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', function() {
    setupEventListeners();
    initChart();
    generateQR();
    const mainApp = document.getElementById('mainApp');
    if (mainApp) mainApp.style.display = 'block';
  });
} else {
  setupEventListeners();
  initChart();
  generateQR();
  const mainApp = document.getElementById('mainApp');
  if (mainApp) mainApp.style.display = 'block';
}

window.runPrediction = runPrediction;
window.runAdvisor = runAdvisor;

</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
