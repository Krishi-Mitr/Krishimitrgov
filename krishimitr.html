<!DOCTYPE html>
<html>
<head>
<title>Buy Crops - KrishiMitra</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="supabase.js"></script>

<style>
body {
  background: linear-gradient(to bottom, #FF9933 0%, #FFFFFF 50%, #138808 100%);
  background-attachment: fixed;
  font-family: Arial;
  padding-top: 90px;
}
.topbar {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    height: 78px;
    display: flex;
    align-items: center;
    padding: 0 18px;
    background: linear-gradient(90deg, #FF9933, #FFFFFF 50%, #138808);
    border-bottom: 3px solid #000080;
    box-shadow: 0 4px 12px rgba(0,0,0,0.25);
    z-index: 9000;
}
.topbar-logo {
    font-size: 26px;
    font-weight: 900;
    color: #000080;
    margin-right: 25px;
}
.topbar-menu {
    display: flex;
    gap: 14px;
}
.topbar-right {
    margin-left: auto;
}
.topbar-right a {
    padding: 8px 16px;
    background: #000080;
    color: white;
    text-decoration: none;
    border-radius: 8px;
    font-weight: 700;
}
.card-custom {
    border: 3px solid #000080;
    border-radius: 15px;
    background: white;
    padding: 18px;
    box-shadow: 0 4px 18px rgba(0,0,0,0.22);
}
.buy-btn {
    width: 100%;
    padding: 10px;
    font-weight: 700;
    border-radius: 8px;
    border: none;
    background: #000080;
    color: white;
}
.btn-dark-toggle {
    padding: 8px 16px;
    background: rgba(255, 255, 255, 0.9);
    color: #000080;
    border-radius: 8px;
    font-weight: 700;
    border: 2px solid #000080;
    cursor: pointer;
    transition: 0.2s;
}
.btn-dark-toggle:hover {
    background: #000080;
    color: white;
}
body.dark {
    background: linear-gradient(to bottom, #1a1a1a 0%, #2d2d2d 50%, #1a1a1a 100%);
    color: #e0e0e0;
}
body.dark .topbar {
    background: linear-gradient(90deg, #2d2d2d, #3d3d3d 50%, #2d2d2d);
    border-bottom: 3px solid #4a9eff;
}
body.dark .topbar-logo {
    color: #4a9eff;
}
body.dark .topbar-right a {
    background: #4a9eff;
    color: white;
}
body.dark .card-custom {
    background: #2d2d2d;
    border-color: #4a9eff;
    color: #e0e0e0;
}
body.dark .buy-btn {
    background: #4a9eff;
}
body.dark .text-muted {
    color: #999 !important;
}
.hamburger {
    display: none;
    font-size: 28px;
    background: none;
    border: none;
    cursor: pointer;
    color: #000080;
    margin-left: 15px;
}
.hamburger-menu {
    position: fixed;
    top: 78px;
    right: -260px;
    width: 250px;
    height: calc(100% - 78px);
    background: white;
    box-shadow: -4px 0 20px rgba(0,0,0,0.25);
    padding: 20px;
    transition: right 0.3s ease;
    z-index: 8999;
    overflow-y: auto;
    border-left: 3px solid #000080;
}
.hamburger-menu.active {
    right: 0;
}
.menu-section {
    margin-bottom: 25px;
}
.menu-section h5 {
    font-weight: 800;
    color: #000080;
    margin-bottom: 10px;
    border-bottom: 2px solid #000080;
    padding-bottom: 5px;
}
.menu-section a {
    display: block;
    text-decoration: none;
    color: #000080;
    font-weight: 700;
    padding: 6px 0;
}
@media (max-width: 900px) {
    .topbar-menu {
        display: none;
    }
    .hamburger {
        display: block;
    }
}
</style>
</head>

<body>

<div class="topbar">
    <div class="topbar-logo">ðŸŒ¾ KrishiMitra</div>

    <!-- FIXED STRUCTURE -->
    <div class="topbar-menu"></div>

    <button class="hamburger" id="hamburgerBtn">â˜°</button>

    <div class="topbar-right" style="display: flex; gap: 10px; align-items: center;">
        <button id="toggleDark" class="btn-dark-toggle">ðŸŒ™ Dark Mode</button>
        <a href="#" id="logout">Logout</a>
    </div>
</div>

<div class="hamburger-menu" id="hamburgerMenu">
    <div class="menu-section">
        <h5>Main</h5>
        <a href="Dashboard.html">Main Page</a>
        <a href="krishimitr.html">Crop Predictor</a>
    </div>
    <div class="menu-section">
        <h5>Market</h5>
        <a href="Buy.html">Buy Crops</a>
        <a href="Sell.html">Sell Crops</a>
        <a href="Update_crops.html">Manage Crops</a>
    </div>
    <div class="menu-section">
        <h5>Tools</h5>
        <a href="Notification.html">Notifications</a>
        <a href="#">Price Charts</a>
    </div>
    <div class="menu-section">
        <h5>System</h5>
        <a href="#" onclick="document.getElementById('toggleDark').click()">Toggle Dark Mode</a>
    </div>
</div>

<div class="container">
    <h2 class="text-center mb-4" style="color:#000080;">Available Crops & Seeds</h2>
    <div class="row g-4" id="cropList"></div>
</div>

<script>
const loginid = sessionStorage.getItem("loginid");
const usertype = sessionStorage.getItem("usertype");

if (!loginid || !usertype) {
    window.location.href = "login.html";
}

async function waitForDB() {
  let attempts = 0;
  while (!window.db && attempts < 50) {
    await new Promise(resolve => setTimeout(resolve, 100));
    attempts++;
  }
  if (!window.db) return false;
  return true;
}

async function init() {
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
    return;
  }
  const dbReady = await waitForDB();
  if (!dbReady) {
    alert("Database connection failed. Please refresh.");
    return;
  }
  loadCrops();
}

async function loadCrops() {
  const currentLoginId = sessionStorage.getItem("loginid");
  const { data: crops, error } = await window.db
    .from("crop_sales")
    .select("*")
    .neq("lid", currentLoginId)
    .order("created_at", { ascending: false });

  const container = document.getElementById("cropList");
  container.innerHTML = "";

  if (error) {
    container.innerHTML = "<p class='text-danger'>Error loading crops</p>";
    return;
  }

  if (!crops || crops.length === 0) {
    container.innerHTML = "<p class='text-muted text-center'>No crops available.</p>";
    return;
  }

  for (const row of crops) {
    container.innerHTML += `
      <div class="col-md-4">
        <div class="card-custom">
          <h4 style="color:#000080;font-weight:700;">${row.crop_name}</h4>
          <p><strong>Farmer:</strong> ${row.farmer_name}</p>
          <p><strong>Quantity:</strong> ${row.quantity} kg</p>
          <p><strong>Price:</strong> â‚¹${row.price} per kg</p>
          <p><strong>Location:</strong> ${row.location}</p>
          <button class="buy-btn">Show Interest</button>
        </div>
      </div>
    `;
  }
}

document.getElementById("logout").onclick = () => {
  sessionStorage.clear();
  location.href = "login.html";
};

const toggleBtn = document.getElementById('toggleDark');
toggleBtn.addEventListener('click', () => {
    document.body.classList.toggle('dark');
    localStorage.setItem('darkMode', document.body.classList.contains('dark'));
});

const hamburgerBtn = document.getElementById("hamburgerBtn");
const hamburgerMenu = document.getElementById("hamburgerMenu");

hamburgerBtn.addEventListener("click", () => {
    hamburgerMenu.classList.toggle("active");
});

window.addEventListener("click", (e) => {
    if (!hamburgerMenu.contains(e.target) && !hamburgerBtn.contains(e.target)) {
        hamburgerMenu.classList.remove("active");
    }
});

if (localStorage.getItem('darkMode') === 'true') {
    document.body.classList.add('dark');
}

init();
</script>

</body>
</html>
