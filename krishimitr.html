<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Krishi Mitr — Crop Market Predictor</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="supabase.js"></script>
<style>
body {
    background: linear-gradient(180deg, #f6e2cc 0%, #f7f9f8 45%, #dceee3 100%);
    font-family: "Poppins", Arial, sans-serif;
    margin: 0;
    padding-top: 80px;
}
.top-nav {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    height: 78px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0 32px;
    background: linear-gradient(90deg,#ff9933,#ffffff,#138808);
    border-bottom: 3px solid #0a3d62;
    box-shadow: 0 6px 14px rgba(0,0,0,0.15);
    z-index: 9999;
}
.nav-left { display: flex; align-items: center; gap: 14px; }
.hamburger-btn {
    width: 44px; height: 44px; border-radius: 12px; border: 2px solid #0a3d62;
    background: rgba(255,255,255,0.75); display: grid; place-items: center; cursor: pointer;
}
.hamburger-icon { width: 20px; height: 14px; position: relative; }
.hamburger-icon span { position: absolute; left: 0; right: 0; height: 2.5px; background: #0a3d62; border-radius: 999px; }
.hamburger-icon span:nth-child(1) { top: 0; }
.hamburger-icon span:nth-child(2) { top: 5.5px; }
.hamburger-icon span:nth-child(3) { top: 11px; }
.brand-title { margin: 0; font-size: 1.15rem; font-weight: 800; color: #0a3d62; }
.logout-btn {
    background: white; color: #0a3d62; border: 2px solid #0a3d62;
    padding: 10px 22px; border-radius: 10px; font-weight: 700; cursor: pointer;
}
.nav-overlay {
    position: fixed; inset: 0; background: rgba(0,0,0,0.25);
    opacity: 0; pointer-events: none; transition: opacity .2s ease; z-index: 9998;
}
.side-drawer {
    position: fixed; top: 84px; left: 14px; width: min(320px, calc(100vw - 28px));
    max-height: calc(100vh - 98px); overflow: auto;
    background: white; border: 3px solid #0a3d62; border-radius: 18px;
    box-shadow: 0 18px 40px rgba(0,0,0,0.22); transform: translateX(-110%);
    transition: transform .25s ease; z-index: 9999;
}
.drawer-inner { padding: 14px; }
.menu-section-drawer {
    border-radius: 14px; overflow: hidden; border: 1px solid rgba(10,61,98,0.18);
    margin-bottom: 14px; background: #ffffff;
}
.menu-section-title { padding: 12px 14px; background: #eef2ff; color: #0a3d62; font-weight: 800; }
.menu-list { list-style: none; padding: 0; margin: 0; }
.menu-list a { display: block; padding: 14px; text-decoration: none; color: #0a3d62; font-weight: 800; background: #f1f5f9; }
body.drawer-open .nav-overlay { opacity: 1; pointer-events: auto; }
body.drawer-open .side-drawer { transform: translateX(0); }
.container { max-width: 1200px; margin: 0 auto; padding: 20px; }
.card { background: white; padding: 20px; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border-left: 5px solid #0a3d62; }
.form-control { border: 2px solid #0a3d62; border-radius: 8px; }
.btn-primary { background: #0a3d62; border: none; }
.btn-success { background: #138808; border: none; }
.chart-container { height: 350px; margin-bottom: 20px; }
#qrCanvas { max-width: 150px; margin-top: 10px; }
</style>
</head>
<body>

<div class="top-nav">
  <div class="nav-left">
    <button class="hamburger-btn" id="menuBtn">
      <div class="hamburger-icon"><span></span><span></span><span></span></div>
    </button>
    <div><p class="brand-title">Krishi Mitr</p></div>
  </div>
  <button class="logout-btn" id="logoutBtn">Logout</button>
</div>

<div class="nav-overlay" id="navOverlay" hidden></div>
<nav class="side-drawer" id="sideNav" hidden>
  <div class="drawer-inner">
    <div class="menu-section-drawer">
      <div class="menu-section-title">Main</div>
      <ul class="menu-list">
        <li><a href="Dashboard">Dashboard</a></li>
      </ul>
    </div>
    <div class="menu-section-drawer">
      <div class="menu-section-title">Market</div>
      <ul class="menu-list">
        <li><a href="Update_crops">Manage Your Crops</a></li>
        <li><a href="Sell">Sell Your Crop</a></li>
        <li><a href="Buy">Buy Crops</a></li>
      </ul>
    </div>
    <div class="menu-section-drawer">
      <div class="menu-section-title">Services</div>
      <ul class="menu-list">
        <li><a href="browse_tools.html">Rent Tools</a></li>
        <li><a href="krishimitr" style="background:#0a3d62; color:white;">Crop Predictor</a></li>
      </ul>
    </div>
  </div>
</nav>

<div class="container">
  <div class="card">
    <h2 style="color:#0a3d62;">Market Forecasting & Advisor</h2>
    <p>Get real-time price predictions and expert agricultural advice for your region.</p>
  </div>

  <div class="row">
    <div class="col-md-5">
      <div class="card">
        <h4 style="color:#0a3d62;">Prediction Settings</h4>
        <div class="mb-3">
          <label class="form-label">Select Crop</label>
          <select id="cropSelect" class="form-control">
            <option value="Wheat">Wheat</option>
            <option value="Rice">Rice</option>
            <option value="Sugarcane">Sugarcane</option>
            <option value="Cotton">Cotton</option>
            <option value="Maize">Maize</option>
          </select>
        </div>
        <div class="mb-3">
          <label class="form-label">Region</label>
          <select id="regionSelect" class="form-control">
            <option value="Punjab">Punjab</option>
            <option value="Maharashtra">Maharashtra</option>
            <option value="Uttar Pradesh">Uttar Pradesh</option>
            <option value="Karnataka">Karnataka</option>
          </select>
        </div>
        <div class="mb-3">
          <label class="form-label">Forecast Horizon (Days): <span id="hval">30</span></label>
          <input type="range" class="form-range" id="horizon" min="7" max="90" value="30">
        </div>
        <button class="btn btn-primary w-100 mb-2" onclick="runPrediction(false)">Predict Market Price</button>
        <button class="btn btn-success w-100" onclick="exportCSV()">Export Analysis</button>
      </div>

      <div class="card">
        <h4 style="color:#0a3d62;">Condition Advisor</h4>
        <div class="mb-3">
          <label class="form-label">Soil Type</label>
          <select id="soilType" class="form-control">
            <option value="Loamy">Loamy</option>
            <option value="Clayey">Clayey</option>
            <option value="Sandy">Sandy</option>
          </select>
        </div>
        <div class="row">
          <div class="col-6 mb-3">
            <label class="form-label">Rainfall (mm)</label>
            <input type="number" id="rainfall" class="form-control" value="200">
          </div>
          <div class="col-6 mb-3">
            <label class="form-label">Temp (°C)</label>
            <input type="number" id="temp" class="form-control" value="25">
          </div>
        </div>
        <button class="btn btn-success w-100" onclick="runAdvisor(true)">Get Farming Advice</button>
      </div>
    </div>

    <div class="col-md-7">
      <div class="card">
        <h4 style="color:#0a3d62;">Price Trend Analysis</h4>
        <div class="chart-container">
          <canvas id="priceChart"></canvas>
        </div>
        <div id="actionCard" class="mt-3 p-3 rounded" style="background:#f8f9fa; border: 1px dashed #0a3d62;">
          <p class="text-muted">Generate a prediction to see market recommendations.</p>
        </div>
      </div>

      <div class="card">
        <h4 style="color:#0a3d62;">Expert Recommendations</h4>
        <div id="advisorOutput" class="p-2">
          Submit your field conditions to receive seed and fertilizer suggestions.
        </div>
      </div>
      
      <div class="card text-center">
        <h4 style="color:#0a3d62;">Share Insights</h4>
        <canvas id="qrCanvas" class="mx-auto"></canvas>
      </div>
    </div>
  </div>
</div>

<script>
const loginid = sessionStorage.getItem("loginid");
if (!loginid) location.href = "login.html";

const menuBtn = document.getElementById("menuBtn");
const sideNav = document.getElementById("sideNav");
const navOverlay = document.getElementById("navOverlay");

menuBtn.onclick = () => {
    const open = document.body.classList.toggle("drawer-open");
    sideNav.hidden = !open;
    navOverlay.hidden = !open;
};
navOverlay.onclick = () => {
    document.body.classList.remove("drawer-open");
    sideNav.hidden = true;
    navOverlay.hidden = true;
};
document.getElementById("logoutBtn").onclick = () => { sessionStorage.clear(); location.href="login.html"; };

const horizonInput = document.getElementById('horizon');
horizonInput.oninput = () => { document.getElementById('hval').innerText = horizonInput.value; };

let priceChart = null;
let lastForecast = [];

function runPrediction(advisor) {
    const crop = document.getElementById('cropSelect').value;
    const region = document.getElementById('regionSelect').value;
    const days = parseInt(horizonInput.value);
    
    const hist = [];
    let base = 2100;
    for(let i=60; i>0; i--) {
        const d = new Date(); d.setDate(d.getDate()-i);
        hist.push({ date: d.toISOString().split('T')[0], price: base + Math.random()*200 });
    }

    const preds = [];
    let lastP = hist[hist.length-1].price;
    for(let i=1; i<=days; i++) {
        const d = new Date(); d.setDate(d.getDate()+i);
        lastP += (Math.random()-0.4)*50;
        preds.push({ date: d.toISOString().split('T')[0], price: lastP });
    }
    
    lastForecast = preds;
    updateChart(hist, preds);
    
    const change = ((preds[preds.length-1].price - hist[hist.length-1].price) / hist[hist.length-1].price) * 100;
    const actionCard = document.getElementById('actionCard');
    if(change > 5) {
        actionCard.innerHTML = `<b style="color:#138808;">Bullish Trend (+${change.toFixed(1)}%)</b>: Prices are rising. We recommend holding your stock for 15 days.`;
    } else {
        actionCard.innerHTML = `<b style="color:#dc3545;">Stable/Bearish Trend (${change.toFixed(1)}%)</b>: Market supply is high. Consider selling at current rates.`;
    }
}

function updateChart(hist, preds) {
    const ctx = document.getElementById('priceChart').getContext('2d');
    if(priceChart) priceChart.destroy();
    
    priceChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [...hist.map(h => h.date), ...preds.map(p => p.date)],
            datasets: [{
                label: 'Historical Price',
                data: [...hist.map(h => h.price), ...new Array(preds.length).fill(null)],
                borderColor: '#0a3d62',
                fill: false
            }, {
                label: 'Forecasted Price',
                data: [...new Array(hist.length).fill(null), ...preds.map(p => p.price)],
                borderColor: '#138808',
                borderDash: [5, 5],
                fill: false
            }]
        },
        options: { responsive: true, maintainAspectRatio: false }
    });
}

function runAdvisor() {
    const soil = document.getElementById('soilType').value;
    const rain = document.getElementById('rainfall').value;
    const crop = document.getElementById('cropSelect').value;
    
    let advice = `For <b>${crop}</b> in <b>${soil}</b> soil: `;
    if(rain < 100) advice += "Water scarcity detected. Use Drip Irrigation and Nitrogen-rich fertilizers.";
    else advice += "Optimal moisture. Use NPK 12-32-16 and high-yield certified seeds.";
    
    document.getElementById('advisorOutput').innerHTML = advice;
}

function exportCSV() {
    if(!lastForecast.length) return alert("Run prediction first");
    let csv = "Date,Price\n" + lastForecast.map(f => `${f.date},${f.price.toFixed(2)}`).join("\n");
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'market_forecast.csv';
    a.click();
}

window.addEventListener('load', () => {
  const hor = document.getElementById('horizon');
  const hval = document.getElementById('hval');
  if(hor) hor.addEventListener('input', () => hval.innerText = hor.value);
  
  document.getElementById('predictBtn').onclick = () => runPrediction(false);
  document.getElementById('combineBtn').onclick = () => runPrediction(true);
  document.getElementById('adviseBtn').onclick = () => runAdvisor(false);
  document.getElementById('exportBtn').onclick = exportCSV;

  if(typeof QRCode !== 'undefined') {
    QRCode.toCanvas(document.getElementById('qrCanvas'), window.location.href, { width: 128 });
  }
  initChart();
});
</script>
</body>
</html>
