<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Notifications - Krishi Mitr</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
  body {
    margin: 0;
    font-family: "Poppins", Arial, sans-serif;
    min-height: 100vh;
    background: linear-gradient(180deg,#f6e2cc 0%,#f7f9f8 45%,#dceee3 100%);
    color: #1f2937;
  }
  /* NAVBAR */
  .top-nav {
    position: fixed;
    top: 0; left: 0; right: 0;
    height: 78px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0 32px;
    background: linear-gradient(90deg,#ff9933,#ffffff,#138808);
    border-bottom: 3px solid #0a3d62;
    box-shadow: 0 6px 14px rgba(0,0,0,0.15);
    z-index: 9999;
  }
  .nav-left {
    display: flex;
    gap: 16px;
  }
  .nav-box {
    background: #0a3d62;
    color: white;
    padding: 10px 20px;
    border-radius: 10px;
    font-weight: 600;
    text-decoration: none;
    transition: .25s;
    cursor: pointer;
  }
  .nav-box:hover {
    background: linear-gradient(135deg,#ff9933,#ffd28a);
    color: black;
    transform: translateY(-3px);
  }
  .logout-btn {
    background: white;
    color: #0a3d62;
    border: 2px solid #0a3d62;
    padding: 10px 22px;
    border-radius: 10px;
    font-weight: 700;
    cursor: pointer;
  }

  /* CONTAINER */
  .container {
    max-width: 900px;
    margin: 110px auto 60px;
    padding: 0 20px;
  }

  /* Notification card */
  .notification-card {
    background: white;
    border-radius: 20px;
    padding: 20px;
    margin-bottom: 18px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    display: flex;
    flex-direction: column;
    gap: 12px;
    word-break: break-word;
  }

  /* Notification text */
  .notification-text {
    font-size: 1.1em;
    color: #1f2937;
  }

  /* Buttons container vertical */
  .actions {
    display: flex;
    flex-direction: column;
    gap: 10px;
    width: 140px;
  }

  button.accept-btn, button.decline-btn {
    padding: 10px;
    font-weight: 700;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    transition: background 0.3s ease;
  }

  button.accept-btn {
    background-color: #138808;
    color: white;
  }
  button.accept-btn:hover {
    background: #0b5e07;
  }

  button.decline-btn {
    background-color: #b30000;
    color: white;
  }
  button.decline-btn:hover {
    background: #7a0000;
  }

  /* Layout inside card */
  .notification-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
  }

  /* Status text */
  .status-text {
    font-weight: 700;
    font-size: 1em;
    padding: 8px 14px;
    border-radius: 14px;
    width: fit-content;
  }

  .status-accepted {
    background-color: #daf6da;
    color: #138808;
    border: 1.5px solid #138808;
  }

  .status-declined {
    background-color: #f8d7da;
    color: #b30000;
    border: 1.5px solid #b30000;
  }

  /* Popup overlay */
  #popup {
    display: none;
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.5);
    justify-content: center;
    align-items: center;
    z-index: 11000;
  }

  #popup-content {
    background: white;
    padding: 30px 40px;
    border-radius: 22px;
    box-shadow: 0 15px 40px rgba(0,0,0,0.25);
    max-width: 420px;
    text-align: center;
    position: relative;
  }

  #popup-content p {
    font-size: 1.2em;
    margin-bottom: 28px;
    color: #1f2937;
  }

  #popup-content button {
    padding: 12px 28px;
    margin: 0 12px;
    font-weight: 700;
    border-radius: 14px;
    cursor: pointer;
    border: none;
    transition: background 0.3s ease;
    font-size: 1em;
  }

  #popup-accept-btn {
    background-color: #138808;
    color: white;
  }
  #popup-accept-btn:hover {
    background: #0b5e07;
  }

  #popup-decline-btn {
    background-color: #b30000;
    color: white;
  }
  #popup-decline-btn:hover {
    background: #7a0000;
  }

  #popup-close-btn {
    position: absolute;
    top: 12px; right: 16px;
    background: #0a3d62;
    color: white;
    border: none;
    border-radius: 50%;
    width: 32px;
    height: 32px;
    font-weight: 700;
    cursor: pointer;
  }
</style>
</head>
<body>

<!-- NAVBAR -->
<div class="top-nav">
  <div class="nav-left" id="navMenu">
    <!-- Nav links inserted here -->
  </div>
  <button id="logoutBtn" class="logout-btn">Logout</button>
</div>

<div class="container" id="notificationsContainer">
  <!-- Notification cards inserted here -->
</div>

<!-- Popup -->
<div id="popup">
  <div id="popup-content">
    <button id="popup-close-btn">&times;</button>
    <p id="popup-message">Are you sure you want to take this action?</p>
    <button id="popup-accept-btn">Accept</button>
    <button id="popup-decline-btn">Decline</button>
  </div>
</div>

<script>
  // Your Supabase config here
  const SUPABASE_URL = "YOUR_SUPABASE_URL";
  const SUPABASE_ANON_KEY = "YOUR_SUPABASE_ANON_KEY";

  const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const loginid = sessionStorage.getItem("loginid");
  const usertype = sessionStorage.getItem("usertype");

  if (!loginid || usertype !== "Farmer") {
    window.location.href = "login";
  }

  // Render navbar with consistent dashboard style
  function renderNavbar() {
    let html = `
      <a href="Dashboard" class="nav-box">Dashboard</a>
      <a href="Sell" class="nav-box">Sell Your Crops</a>
      <a href="Buy" class="nav-box">Buy Crops</a>
      <a href="Notification" class="nav-box">Notifications</a>
      <a href="krishimitr" class="nav-box">Crop Price Predictor</a>
    `;
    document.getElementById("navMenu").innerHTML = html;
  }

  const notificationsContainer = document.getElementById("notificationsContainer");
  const popup = document.getElementById("popup");
  const popupMessage = document.getElementById("popup-message");
  const popupAcceptBtn = document.getElementById("popup-accept-btn");
  const popupDeclineBtn = document.getElementById("popup-decline-btn");
  const popupCloseBtn = document.getElementById("popup-close-btn");

  let selectedNotification = null;
  let selectedAction = null;

  // Load notifications for this farmer (fid = loginid)
  async function loadNotifications() {
    const { data, error } = await supabaseClient
      .from('buy_table')
      .select(`
        id,
        fname,
        lid,
        cname,
        quantity,
        is_confirmed
      `)
      .eq('fid', loginid)
      .order('created_at', { ascending: false });

    if (error) {
      notificationsContainer.innerHTML = `<p style="color:red;">Error loading notifications: ${error.message}</p>`;
      return;
    }

    if (!data || data.length === 0) {
      notificationsContainer.innerHTML = `<h3>No notifications yet.</h3>`;
      return;
    }

    notificationsContainer.innerHTML = '';

    for (const notification of data) {
      // Get buyer name from logindata by lid
      const { data: buyerData, error: buyerError } = await supabaseClient
        .from('logindata')
        .select('name')
        .eq('loginid', notification.lid.toString())
        .maybeSingle();

      const buyerName = buyerError || !buyerData ? 'Unknown Buyer' : buyerData.name;

      const card = document.createElement('div');
      card.className = 'notification-card';

      let statusText = '';
      if (notification.is_confirmed === true) {
        statusText = `<div class="status-text status-accepted">Accepted</div>`;
      } else if (notification.is_confirmed === false && notification.status === 'Declined') {
        statusText = `<div class="status-text status-declined">Declined</div>`;
      } else {
        statusText = '';
      }

      card.innerHTML = `
        <div class="notification-content">
          <div class="notification-text">
            <strong>${buyerName}</strong> wants to buy <strong>${notification.quantity} kg</strong> of your <strong>${notification.cname}</strong> crop.
          </div>
          ${statusText}
          ${notification.is_confirmed === null || notification.is_confirmed === false
            ? `<div class="actions">
                <button class="accept-btn">Accept</button>
                <button class="decline-btn">Decline</button>
               </div>`
            : ''
          }
        </div>
      `;

      // Append card
      notificationsContainer.appendChild(card);

      // Add event listeners to buttons if not confirmed yet
      if (notification.is_confirmed === null || notification.is_confirmed === false) {
        const acceptBtn = card.querySelector('.accept-btn');
        const declineBtn = card.querySelector('.decline-btn');

        acceptBtn.onclick = () => openConfirmPopup(notification, 'accept');
        declineBtn.onclick = () => openConfirmPopup(notification, 'decline');
      }
    }
  }

  function openConfirmPopup(notification, action) {
    selectedNotification = notification;
    selectedAction = action;

    popupMessage.textContent =
      action === 'accept'
        ? `Do you want to ACCEPT selling your crop to this person? This action cannot be undone.`
        : `Do you want to DECLINE selling your crop to this person? This action cannot be undone.`;

    popup.style.display = 'flex';
  }

  popupAcceptBtn.onclick = async () => {
    await updateNotification(selectedNotification.id, selectedAction === 'accept');
    popup.style.display = 'none';
  };

  popupDeclineBtn.onclick = async () => {
    await updateNotification(selectedNotification.id, false, true);
    popup.style.display = 'none';
  };

  popupCloseBtn.onclick = () => {
    popup.style.display = 'none';
  };

  // Update is_confirmed and status in buy_table
  async function updateNotification(id, isConfirmed, isDecline = false) {
    let statusValue = isDecline ? 'Declined' : 'Accepted';
    try {
      const { error } = await supabaseClient
        .from('buy_table')
        .update({
          is_confirmed: isConfirmed,
          status: statusValue
        })
        .eq('id', id);

      if (error) {
        alert("Error updating status: " + error.message);
        return;
      }

      alert(`Request ${statusValue.toLowerCase()} successfully!`);
      await loadNotifications();

    } catch (err) {
      alert("Unexpected error: " + err.message);
    }
  }

  document.getElementById("logoutBtn").onclick = () => {
    sessionStorage.clear();
    window.location.href = "login";
  };

  renderNavbar();
  loadNotifications();
</script>

</body>
</html>
