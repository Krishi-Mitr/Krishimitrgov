<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Notifications - Krishi Mitr</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="supabase.js"></script>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
body{
  margin:0;
  font-family:"Poppins", Arial;
  background: linear-gradient(180deg,#f6e2cc 0%,#f7f9f8 45%,#dceee3 100%);
  padding-top:100px;
}

.container{
  max-width:900px;
}

.notify-card{
  background:white;
  border-radius:18px;
  padding:20px;
  box-shadow:0 15px 35px rgba(0,0,0,0.15);
}

.accept-btn{
  background:#138808;
  color:white;
  border:none;
  padding:8px 16px;
  border-radius:8px;
  font-weight:600;
}

.reject-btn{
  background:#dc2626;
  color:white;
  border:none;
  padding:8px 16px;
  border-radius:8px;
  font-weight:600;
}

.status-badge{
  padding:6px 12px;
  border-radius:20px;
  font-weight:600;
}
.pending{ background:#facc15; color:black;}
.completed{ background:#16a34a; color:white;}
.rejected{ background:#ef4444; color:white;}
</style>
</head>

<body>

<div class="container">
<h2 class="text-center mb-4">Buyer Notifications</h2>
<div id="notificationList"></div>
</div>

<script>

const loginid = sessionStorage.getItem("loginid");
const usertype = sessionStorage.getItem("usertype");

if(!loginid || usertype !== "Farmer"){
    window.location.href="login";
}

async function loadNotifications(){

    const { data, error } = await window.db
        .from("buy_table")
        .select("*")
        .eq("lid", loginid)
        .order("created_at",{ascending:false});

    if(error){
        alert(error.message);
        return;
    }

    const container=document.getElementById("notificationList");
    container.innerHTML="";

    if(!data.length){
        container.innerHTML="<p class='text-center text-muted'>No notifications yet</p>";
        return;
    }

    for(const row of data){

        const { data:crop } = await window.db
            .from("crop_sales")
            .select("crop_name")
            .eq("jid",row.fid)
            .maybeSingle();

        const cropName = crop?.crop_name || "Crop";

        container.innerHTML+=`
        <div class="notify-card mb-4">
            <h5>${cropName}</h5>
            <p><b>Buyer:</b> ${row.cname}</p>
            <p><b>Quantity:</b> ${row.quantity} kg</p>
            <p><b>Date:</b> ${new Date(row.created_at).toLocaleString()}</p>
            <p><b>Status:</b> 
              <span class="status-badge ${row.status}">
                ${row.status}
              </span>
            </p>

            ${row.status === "pending" ? `
            <button class="accept-btn me-2"
              onclick="updateStatus(${row.id},'completed')">
              Accept
            </button>

            <button class="reject-btn"
              onclick="updateStatus(${row.id},'rejected')">
              Reject
            </button>
            ` : ""}
        </div>
        `;
    }
}

async function updateStatus(id,newStatus){

    if(!confirm("Are you sure?")) return;

    const { error } = await window.db
        .from("buy_table")
        .update({
            status:newStatus,
            is_confirmed: newStatus === "completed"
        })
        .eq("id",id);

    if(error){
        alert(error.message);
        return;
    }

    alert("Status updated successfully");
    loadNotifications();
}

loadNotifications();

</script>

</body>
</html>
