<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Farmer Dashboard - Krishi Mitr</title>

<!-- Supabase JS -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
  /* Reset & basics */
  * {
    box-sizing: border-box;
  }
  body {
    margin: 0;
    font-family: 'Poppins', Arial, sans-serif;
    background: linear-gradient(180deg, #f6e2cc 0%, #f7f9f8 45%, #dceee3 100%);
    color: #1f2937;
    min-height: 100vh;
    padding-top: 80px;
  }

  /* Navbar */
  .navbar {
    position: fixed;
    top: 0; left: 0; right: 0;
    height: 78px;
    background: linear-gradient(90deg,#ff9933,#138808);
    display: flex;
    align-items: center;
    padding: 0 30px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    font-weight: 700;
    color: white;
    z-index: 1000;
  }

  /* Container */
  .container {
    max-width: 900px;
    margin: 0 auto 40px;
    padding: 20px;
  }

  /* Header */
  h1 {
    color: #0a3d62;
    margin-bottom: 20px;
  }

  /* Notification Card */
  .notification-card {
    background: white;
    border-radius: 18px;
    padding: 20px 25px;
    margin-bottom: 16px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  /* Status colors */
  .status {
    font-weight: 600;
  }
  .status.pending {
    color: #2563eb; /* blue */
  }
  .status.accepted {
    color: #16a34a; /* green */
  }
  .status.declined {
    color: #dc2626; /* red */
  }

  /* Info lines */
  .info-line {
    font-size: 1.05em;
  }

  /* Actions vertical */
  .actions {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-top: 10px;
    max-width: 150px;
  }
  .actions button {
    padding: 12px;
    border: none;
    border-radius: 10px;
    font-weight: 700;
    font-size: 1em;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }
  .actions button.accept {
    background-color: #16a34a;
    color: white;
  }
  .actions button.accept:hover {
    background-color: #15803d;
  }
  .actions button.decline {
    background-color: #dc2626;
    color: white;
  }
  .actions button.decline:hover {
    background-color: #b91c1c;
  }

  /* Modal overlay */
  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.6);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 2000;
  }

  /* Modal content */
  .modal {
    background: white;
    border-radius: 16px;
    max-width: 400px;
    width: 90%;
    padding: 30px 25px;
    box-shadow: 0 15px 40px rgba(0,0,0,0.25);
    text-align: center;
  }
  .modal h2 {
    margin-top: 0;
    color: #0a3d62;
  }
  .modal p {
    margin: 20px 0 30px;
    font-size: 1.1em;
    color: #374151;
  }
  .modal-buttons {
    display: flex;
    justify-content: center;
    gap: 20px;
  }
  .modal-buttons button {
    flex: 1;
    padding: 12px 0;
    border: none;
    border-radius: 10px;
    font-weight: 700;
    font-size: 1.1em;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }
  .modal-buttons button.confirm {
    background-color: #16a34a;
    color: white;
  }
  .modal-buttons button.confirm:hover {
    background-color: #15803d;
  }
  .modal-buttons button.cancel {
    background-color: #dc2626;
    color: white;
  }
  .modal-buttons button.cancel:hover {
    background-color: #b91c1c;
  }
</style>
</head>
<body>

<div class="navbar">Farmer Dashboard - Krishi Mitr</div>

<div class="container">
  <h1>Buy Requests</h1>
  <div id="notifications">
    <!-- Notifications will appear here -->
  </div>
</div>

<!-- Confirmation Modal -->
<div id="confirmModal" class="modal-overlay">
  <div class="modal">
    <h2>Confirm Action</h2>
    <p id="modalMessage">Are you sure?</p>
    <div class="modal-buttons">
      <button class="confirm" id="confirmBtn">Confirm</button>
      <button class="cancel" id="cancelBtn">Cancel</button>
    </div>
  </div>
</div>

<script>
  // Supabase setup
  const SUPABASE_URL = 'YOUR_SUPABASE_URL';
  const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY';
  const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // Session info
  const loginid = sessionStorage.getItem("loginid");
  const usertype = sessionStorage.getItem("usertype");

  if (!loginid || usertype !== "Farmer") {
    window.location.href = "login";
  }

  const notificationsEl = document.getElementById("notifications");
  const confirmModal = document.getElementById("confirmModal");
  const modalMessage = document.getElementById("modalMessage");
  const confirmBtn = document.getElementById("confirmBtn");
  const cancelBtn = document.getElementById("cancelBtn");

  let currentRequest = null;
  let currentAction = null;

  // Fetch buy_table entries for this farmer (fid == loginid) and status not confirmed yet
  async function fetchNotifications() {
    const { data, error } = await supabase
      .from('buy_table')
      .select('*')
      .eq('fid', loginid)
      .is('is_confirmed', null);  // only pending (is_confirmed null) or you can use false depending on your logic

    if (error) {
      notificationsEl.innerHTML = `<p style="color:red;">Failed to load notifications: ${error.message}</p>`;
      return;
    }

    renderNotifications(data || []);
  }

  // Render notifications vertically
  function renderNotifications(notifications) {
    if (!notifications.length) {
      notificationsEl.innerHTML = "<p>No buy requests at the moment.</p>";
      return;
    }

    notificationsEl.innerHTML = '';

    notifications.forEach(notif => {
      // Show buyer's name by looking up in logindata by lid (buyer loginid)
      // We'll fetch buyer name inside render for simplicity

      getBuyerName(notif.lid).then(buyerName => {
        const card = document.createElement('div');
        card.className = 'notification-card';

        // Status text and color
        let statusText = 'Pending';
        let statusClass = 'pending';
        if (notif.is_confirmed === true) {
          statusText = 'Accepted';
          statusClass = 'accepted';
        } else if (notif.is_confirmed === false) {
          statusText = 'Declined';
          statusClass = 'declined';
        }

        card.innerHTML = `
          <div class="info-line"><b>${notif.fname}</b> wants to buy</div>
          <div class="info-line"><b>${notif.quantity} kg</b> of <b>${notif.cname}</b> crop.</div>
          <div class="status ${statusClass}">Status: ${statusText}</div>
        `;

        // Add Accept/Decline buttons only if pending
        if (notif.is_confirmed === null || notif.is_confirmed === false) {
          const actions = document.createElement('div');
          actions.className = 'actions';

          const acceptBtn = document.createElement('button');
          acceptBtn.textContent = 'Accept';
          acceptBtn.className = 'accept';
          acceptBtn.onclick = () => openConfirmModal(notif, true);

          const declineBtn = document.createElement('button');
          declineBtn.textContent = 'Decline';
          declineBtn.className = 'decline';
          declineBtn.onclick = () => openConfirmModal(notif, false);

          actions.appendChild(acceptBtn);
          actions.appendChild(declineBtn);

          card.appendChild(actions);
        }

        notificationsEl.appendChild(card);
      });
    });
  }

  // Get buyer name by loginid from logindata table
  async function getBuyerName(buyerLoginId) {
    const { data, error } = await supabase
      .from('logindata')
      .select('name')
      .eq('loginid', buyerLoginId.toString())
      .maybeSingle();

    if (error || !data) return 'Unknown';
    return data.name;
  }

  // Show modal with message and store current action
  function openConfirmModal(request, action) {
    currentRequest = request;
    currentAction = action;
    modalMessage.textContent = `Do you want to ${action ? 'accept' : 'decline'} the request from ${request.fname} for ${request.quantity} kg of ${request.cname}? This action cannot be undone.`;
    confirmModal.style.display = 'flex';
  }

  // Close modal
  function closeConfirmModal() {
    confirmModal.style.display = 'none';
    currentRequest = null;
    currentAction = null;
  }

  // Confirm button clicked
  async function onConfirm() {
    if (!currentRequest) return;

    // Update is_confirmed in buy_table
    const { error } = await supabase
      .from('buy_table')
      .update({ is_confirmed: currentAction })
      .eq('id', currentRequest.id);

    if (error) {
      alert(`Error updating status: ${error.message}`);
      closeConfirmModal();
      return;
    }

    closeConfirmModal();
    fetchNotifications();  // refresh list
  }

  // Event listeners
  confirmBtn.addEventListener('click', onConfirm);
  cancelBtn.addEventListener('click', closeConfirmModal);

  // Close modal if clicking outside modal content
  confirmModal.addEventListener('click', e => {
    if (e.target === confirmModal) closeConfirmModal();
  });

  // Initialize
  fetchNotifications();
</script>

</body>
</html>
