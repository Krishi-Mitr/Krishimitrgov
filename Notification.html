<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Dashboard - Notifications</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="supabase.js"></script>

<style>
body{
  background:#eef2f6;
  padding-top:90px;
  font-family:Inter,Arial;
}
.top-navbar{
  position:fixed;
  top:0;left:0;right:0;
  height:75px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:14px 26px;
  background:#0b6623;
  color:#fff;
  z-index:9999;
}
.nav-link-custom{
  background:#fff;
  padding:8px 14px;
  border-radius:8px;
  font-weight:600;
  text-decoration:none;
  color:#000;
}
.dashboard-card{
  border-radius:14px;
  box-shadow:0 6px 18px rgba(0,0,0,.08);
}
.status-badge{
  font-size:.8rem;
}
</style>
</head>

<body>

<!-- NAVBAR -->
<div class="top-navbar">
  <div class="fw-bold fs-5">ðŸŒ¾ KrishiMitra Dashboard</div>
  <div class="d-flex gap-2">
    <a href="Dashboard.html" class="nav-link-custom">Home</a>
    <a href="Sell.html" class="nav-link-custom">Sell</a>
    <a href="Buy.html" class="nav-link-custom">Buy</a>
    <a href="#" id="logoutBtn" class="nav-link-custom">Logout</a>
  </div>
</div>

<!-- CONTENT -->
<div class="container" id="main" style="display:none">
  <h4 class="mb-4">ðŸ”” Purchase Requests</h4>
  <div id="notifContainer" class="d-flex flex-column gap-3"></div>
</div>

<div class="container" id="denied" style="display:none">
  <div class="card p-4 text-center">
    <h5 class="text-danger">Access Denied</h5>
    <p>Only farmers can view notifications.</p>
  </div>
</div>

<script>
const loginid = sessionStorage.getItem("loginid");
const usertype = sessionStorage.getItem("usertype");

if (!loginid || usertype !== "Farmer") {
  document.getElementById("denied").style.display = "block";
  throw "";
}

document.getElementById("main").style.display = "block";

async function loadNotifications() {
  const { data: orders, error } = await window.db
    .from("buy_table")
    .select("*")
    .eq("fid", loginid)
    .order("created_at", { ascending:false });

  const container = document.getElementById("notifContainer");
  container.innerHTML = "";

  if (error || !orders || orders.length === 0) {
    container.innerHTML = `
      <div class="card dashboard-card p-4 text-center text-muted">
        No purchase requests yet
      </div>`;
    return;
  }

  for (const row of orders) {

    const { data: buyer } = await window.db
      .from("logindata")
      .select("name")
      .eq("loginid", row.lid)
      .maybeSingle();

    const buyerName = buyer?.name || "Buyer";

    let statusHTML = "";
    let actionHTML = "";

    if (row.is_confirmed === true) {
      statusHTML = `<span class="badge bg-success status-badge">Accepted</span>`;
    } 
    else if (row.is_confirmed === false) {
      statusHTML = `<span class="badge bg-danger status-badge">Declined</span>`;
    } 
    else {
      actionHTML = `
        <div class="mt-3 d-flex gap-2">
          <button class="btn btn-success btn-sm"
            onclick="updateStatus(${row.id}, true)">Accept</button>
          <button class="btn btn-danger btn-sm"
            onclick="updateStatus(${row.id}, false)">Decline</button>
        </div>`;
    }

    container.innerHTML += `
      <div class="card dashboard-card p-4">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <p class="mb-2">
              <strong>${buyerName}</strong> wants to buy
              <strong>${row.quantity} kg</strong> of your
              <strong>${row.cname}</strong> crop
            </p>
            <small class="text-muted">
              ${new Date(row.created_at).toLocaleString()}
            </small>
          </div>
          ${statusHTML}
        </div>
        ${actionHTML}
      </div>`;
  }
}

async function updateStatus(id, value) {
  await window.db
    .from("buy_table")
    .update({ is_confirmed: value })
    .eq("id", id);

  loadNotifications();
}

document.getElementById("logoutBtn").onclick = () => {
  sessionStorage.clear();
  location.href = "login.html";
};

loadNotifications();
</script>

</body>
</html>
