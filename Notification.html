<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Notifications ‚Äì KrishiMitra</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="supabase.js"></script>

<style>
body{
  background:#f4f6f9;
  padding-top:90px;
  font-family:Inter,Arial,sans-serif;
}
.top-navbar{
  position:fixed;top:0;left:0;right:0;height:75px;
  display:flex;align-items:center;justify-content:space-between;
  padding:12px 22px;
  background:#0B6623;
  color:#fff;
  z-index:9999;
}
.nav-link-custom{
  background:#fff;
  padding:8px 14px;
  border-radius:8px;
  font-weight:600;
  text-decoration:none;
  color:#000;
}
.notification-card{
  border-radius:14px;
  box-shadow:0 6px 18px rgba(0,0,0,.08);
}
.status-badge{
  font-size:.75rem;
}
</style>
</head>

<body>

<!-- NAVBAR -->
<div class="top-navbar">
  <div class="fw-bold fs-5">üåæ KrishiMitra</div>
  <div class="d-flex gap-2">
    <a href="Dashboard" class="nav-link-custom">Dashboard</a>
    <a href="Sell" class="nav-link-custom">Sell</a>
    <a href="Buy" class="nav-link-custom">Buy</a>
    <a href="#" id="logoutBtn" class="nav-link-custom">Logout</a>
  </div>
</div>

<!-- CONTENT -->
<div class="container" id="content" style="display:none">
  <h4 class="mb-4">Purchase Requests</h4>
  <div id="notifContainer" class="d-flex flex-column gap-3"></div>
</div>

<div class="container" id="denied" style="display:none">
  <div class="card p-4 text-center">
    <h5 class="text-danger">Access Denied</h5>
    <p>Only farmers can view this page.</p>
  </div>
</div>

<script>
const loginid = sessionStorage.getItem("loginid");
const usertype = sessionStorage.getItem("usertype");

if (!loginid || usertype !== "Farmer") {
  document.getElementById("denied").style.display = "block";
  throw "";
}

document.getElementById("content").style.display = "block";

async function loadNotifications() {

  // 1Ô∏è‚É£ Find buy requests for THIS farmer
  const { data: requests, error } = await window.db
    .from("buy_table")
    .select("*")
    .eq("fid", loginid)
    .order("created_at", { ascending: false });

  const container = document.getElementById("notifContainer");
  container.innerHTML = "";

  if (error || !requests || requests.length === 0) {
    container.innerHTML = `
      <div class="card p-4 text-muted text-center">
        No purchase requests yet
      </div>`;
    return;
  }

  for (const req of requests) {

    // 2Ô∏è‚É£ Get buyer name
    const { data: buyer } = await window.db
      .from("logindata")
      .select("name")
      .eq("loginid", req.lid)
      .maybeSingle();

    const buyerName = buyer?.name || "Someone";

    const statusText = req.is_confirmed === true
      ? `<span class="badge bg-success status-badge">Accepted</span>`
      : req.is_confirmed === false
        ? `<span class="badge bg-danger status-badge">Declined</span>`
        : "";

    const buttonsDisabled = req.is_confirmed !== null ? "disabled" : "";

    container.innerHTML += `
      <div class="card notification-card p-4">
        <div class="d-flex justify-content-between">
          <div class="w-100">
            <p class="mb-2">
              <strong>${buyerName}</strong> wants to buy
              <strong>${req.quantity} kg</strong> of your
              <strong>${req.cname}</strong> crop.
            </p>
            <small class="text-muted">
              ${new Date(req.created_at).toLocaleString()}
            </small>
          </div>
          <div>${statusText}</div>
        </div>

        ${req.is_confirmed === null ? `
        <div class="mt-3 d-flex gap-2">
          <button class="btn btn-success btn-sm"
            onclick="updateStatus(${req.id}, true)">
            Accept
          </button>
          <button class="btn btn-danger btn-sm"
            onclick="updateStatus(${req.id}, false)">
            Decline
          </button>
        </div>` : ``}
      </div>`;
  }
}

async function updateStatus(id, value) {
  await window.db
    .from("buy_table")
    .update({ is_confirmed: value })
    .eq("id", id);

  loadNotifications(); // refresh
}

document.getElementById("logoutBtn").onclick = () => {
  sessionStorage.clear();
  location.href = "loginml";
};

loadNotifications();
</script>

</body>
</html>
