<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Notifications - KrishiMitra</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="supabase.js"></script>

<style>
body{
  background:#f4f6f9;
  padding-top:90px;
  font-family:Inter,Arial,sans-serif;
}
.top-navbar{
  position:fixed;top:0;left:0;right:0;height:75px;
  display:flex;align-items:center;justify-content:space-between;
  padding:12px 22px;
  background:#0B6623;
  color:#fff;
  z-index:9999;
}
.nav-link-custom{
  background:#fff;
  padding:8px 14px;
  border-radius:8px;
  font-weight:600;
  text-decoration:none;
  color:#000;
}
.card{
  border-radius:14px;
  box-shadow:0 6px 18px rgba(0,0,0,.08);
}
.badge-confirmed{
  background:#198754;
}
</style>
</head>

<body>

<!-- NAVBAR -->
<div class="top-navbar">
  <div class="fw-bold fs-5">KrishiMitra</div>
  <div class="d-flex gap-2">
    <a href="Dashboard" class="nav-link-custom">Dashboard</a>
     <a href="krishimitr" class="nav-link-custom">Crop price predictor</a>
    <a href="YourCrops" class="nav-link-custom">Your crops</a>
    <a href="Buy" class="nav-link-custom">Buy</a>
    <a href="#" id="logoutBtn" class="nav-link-custom">Logout</a>
  </div>
</div>

<!-- CONTENT -->
<div class="container" id="content" style="display:none">
  <h4 class="mb-4">Purchase Notifications</h4>
  <div id="notifContainer"></div>
</div>

<div class="container" id="denied" style="display:none">
  <div class="card p-4 text-center">
    <h5 class="text-danger">Access Denied</h5>
    <p>Only farmers can view notifications.</p>
  </div>
</div>

<script>
const loginid = sessionStorage.getItem("loginid");
const usertype = sessionStorage.getItem("usertype");

if (!loginid || !usertype) {
  location.href = "login";
  throw "";
}

if (usertype !== "Farmer") {
  document.getElementById("denied").style.display = "block";
  throw "";
}

document.getElementById("content").style.display = "block";

async function loadNotifications() {

  const { data: buys, error } = await window.db
    .from("buy_table")
    .select("*")
    .eq("lid", loginid)
    .eq("is_confirmed", true)
    .order("created_at", { ascending: false });

  const container = document.getElementById("notifContainer");
  container.innerHTML = "";

  if (error) {
    container.innerHTML = `<div class="card p-3 text-danger">Error loading notifications</div>`;
    return;
  }

  if (!buys || buys.length === 0) {
    container.innerHTML = `
      <div class="card p-4 text-muted text-center">
        No confirmed purchases yet
      </div>`;
    return;
  }

  for (const buy of buys) {

    const { data: crop } = await window.db
      .from("crop_sales")
      .select("crop_name, price, location")
      .eq("jid", buy.fid)
      .maybeSingle();

    container.innerHTML += `
      <div class="card p-4 mb-3">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <h6 class="mb-1">${crop?.crop_name || "Crop"}</h6>
            <p class="mb-1">
              Buyer: <strong>${buy.cname}</strong><br>
              Quantity: <strong>${buy.quantity} kg</strong><br>
              Price: â‚¹${crop?.price}/kg<br>
              Location: ${crop?.location}
            </p>
            <small class="text-muted">
              ${new Date(buy.created_at).toLocaleString()}
            </small>
          </div>
          <span class="badge badge-confirmed">Confirmed</span>
        </div>
      </div>`;
  }
}

document.getElementById("logoutBtn").onclick = () => {
  sessionStorage.clear();
  location.href = "login";
};

loadNotifications();
</script>

</body>
</html>
