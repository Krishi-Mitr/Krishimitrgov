<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Notifications - Krishi Mitr</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="supabase.js"></script>

<style>
body{
  margin:0;
  font-family:Poppins,Arial,sans-serif;
  background:linear-gradient(180deg,#f6e2cc,#f7f9f8,#dceee3);
}

/* NAVBAR */
.top-nav{
  position:fixed;
  top:0;left:0;right:0;
  height:78px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:0 32px;
  background:linear-gradient(90deg,#ff9933,#fff,#138808);
  border-bottom:3px solid #0a3d62;
  z-index:9999;
}

.nav-box{
  background:#0a3d62;
  color:#fff;
  padding:10px 20px;
  border-radius:10px;
  font-weight:600;
  text-decoration:none;
}

.logout-btn{
  background:#fff;
  border:2px solid #0a3d62;
  padding:10px 20px;
  border-radius:10px;
  font-weight:700;
}

/* CONTENT */
.container{
  max-width:900px;
  margin:120px auto 50px;
  padding:0 20px;
}

/* CARD */
.request-card{
  background:#fff;
  border-radius:18px;
  padding:22px;
  margin-bottom:20px;
  box-shadow:0 10px 25px rgba(0,0,0,.15);
}

.request-text{
  font-size:1.1em;
  color:#0a3d62;
  font-weight:600;
  margin-bottom:14px;
}

/* BUTTONS VERTICAL */
.btn-group{
  display:flex;
  flex-direction:column;
  gap:10px;
}

.accept-btn{
  background:#138808;
  color:white;
  border:none;
  padding:12px;
  border-radius:10px;
  font-weight:700;
  cursor:pointer;
}

.decline-btn{
  background:#b30000;
  color:white;
  border:none;
  padding:12px;
  border-radius:10px;
  font-weight:700;
  cursor:pointer;
}

/* CONFIRM BOX */
.confirm-box{
  margin-top:14px;
  padding:14px;
  border:2px solid #0a3d62;
  border-radius:10px;
  background:#f0f9ff;
}

.confirm-box p{
  font-weight:600;
  margin-bottom:10px;
}

.confirm-actions{
  display:flex;
  flex-direction:column;
  gap:8px;
}

.confirm-yes{
  background:#138808;
  color:white;
  border:none;
  padding:10px;
  border-radius:8px;
  font-weight:700;
}

.confirm-no{
  background:#6b7280;
  color:white;
  border:none;
  padding:10px;
  border-radius:8px;
  font-weight:700;
}

.disabled{
  opacity:.6;
  pointer-events:none;
}
</style>
</head>

<body>

<div class="top-nav">
  <a class="nav-box" href="Dashboard">Dashboard</a>
  <button class="logout-btn" id="logoutBtn">Logout</button>
</div>

<div class="container" id="notificationList"></div>

<script>
const db = window.db;
const loginid = sessionStorage.getItem("loginid");
const usertype = sessionStorage.getItem("usertype");

if (!loginid || usertype !== "Farmer") {
  location.href = "login";
}

async function loadNotifications(){
  const { data } = await db
    .from("buy_table")
    .select("*")
    .eq("fid", loginid)
    .order("created_at",{ascending:false});

  const container = document.getElementById("notificationList");
  container.innerHTML = "";

  if (!data || data.length === 0){
    container.innerHTML = "<h3>No notifications yet</h3>";
    return;
  }

  for (const req of data){

    const { data: buyer } = await db
      .from("logindata")
      .select("name")
      .eq("loginid", req.lid)
      .maybeSingle();

    const card = document.createElement("div");
    card.className = "request-card";

    card.innerHTML = `
      <div class="request-text">
        <strong>${buyer?.name || "Someone"}</strong> wants to buy
        <strong>${req.quantity} kg</strong> of your
        <strong>${req.cname}</strong> crop
      </div>

      <div class="btn-group">
        <button class="accept-btn">Accept</button>
        <button class="decline-btn">Decline</button>
      </div>
    `;

    const acceptBtn = card.querySelector(".accept-btn");
    const declineBtn = card.querySelector(".decline-btn");

    if (req.is_confirmed){
      acceptBtn.classList.add("disabled");
      declineBtn.classList.add("disabled");
    }

    acceptBtn.onclick = () => showConfirm(card, req.id, "Accepted");
    declineBtn.onclick = () => showConfirm(card, req.id, "Declined");

    container.appendChild(card);
  }
}

function showConfirm(card, id, status){
  if (card.querySelector(".confirm-box")) return;

  const box = document.createElement("div");
  box.className = "confirm-box";
  box.innerHTML = `
    <p>Do you want to sell your crop to this person?</p>
    <div class="confirm-actions">
      <button class="confirm-yes">Yes, Confirm</button>
      <button class="confirm-no">Cancel</button>
    </div>
  `;

  card.appendChild(box);

  box.querySelector(".confirm-yes").onclick = async () => {
    await db.from("buy_table").update({
      is_confirmed: true,
      status: status
    }).eq("id", id);

    loadNotifications();
  };

  box.querySelector(".confirm-no").onclick = () => {
    box.remove();
  };
}

document.getElementById("logoutBtn").onclick = () => {
  sessionStorage.clear();
  location.href = "login";
};

loadNotifications();
</script>

</body>
</html>
