<!DOCTYPE html>
<html>
<head>
<title>Sell Crops - KrishiMitra</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="supabase.js"></script>

<style>
body {
  background: linear-gradient(to bottom, #FF9933 0%, #FFFFFF 50%, #138808 100%);
  background-attachment: fixed;
  font-family: Arial;
  padding-top: 90px;
}

.topbar {
  position: fixed;
  top: 0; left: 0; right: 0;
  height: 78px;
  display: flex;
  align-items: center;
  padding: 0 18px;
  background: linear-gradient(90deg, #FF9933, #FFFFFF 50%, #138808);
  border-bottom: 3px solid #000080;
  z-index: 9000;
}

.topbar-logo {
  font-size: 26px;
  font-weight: 900;
  color: #000080;
  margin-right: 25px;
}

.topbar-menu { display: flex; gap: 14px; }

.topbar-menu a {
  text-decoration: none;
  padding: 10px 16px;
  border-radius: 8px;
  font-weight: 700;
  color: #000080;
}

.topbar-right { margin-left: auto; }

.topbar-right a {
  padding: 8px 16px;
  background: #000080;
  color: white;
  border-radius: 8px;
  font-weight: 700;
  text-decoration: none;
}

.form-container {
  width: 520px;
  background: white;
  padding: 25px;
  border-radius: 15px;
  margin: auto;
  border: 3px solid #000080;
}

.success {
  background: #d4edda;
  padding: 10px;
  border-left: 4px solid #138808;
  margin-bottom: 15px;
}

.list-box {
  background: white;
  padding: 18px;
  border-radius: 15px;
  margin-top: 25px;
  border: 2px solid #000080;
}
</style>
</head>

<body>

<!-- TOP BAR -->
<div class="topbar">
  <div class="topbar-logo">ðŸŒ¾ KrishiMitra</div>

  <div class="topbar-menu">
    <a href="Dashboard.html">Dashboard</a>
    <a href="Buy.html">Buy Crops</a>
    <a href="krishimitr.html">Crop Predictor</a>
    <a href="Notification.html">Notification</a>
  </div>

  <div class="topbar-right">
    <a href="#" id="logoutBtn">Logout</a>
  </div>
</div>

<div class="container mt-4">

<div id="messageBox"></div>

<!-- SELL FORM -->
<div class="form-container">
  <h4>Sell Your Crops</h4>

  <form id="sellForm">
    <label>Farmer</label>
    <input type="text" id="farmerName" class="form-control" readonly>

    <label class="mt-2">Crop Name</label>
    <input type="text" id="crop_name" class="form-control" required>

    <label class="mt-2">Quantity (kg)</label>
    <input type="number" id="quantity" class="form-control" required>

    <label class="mt-2">Price (â‚¹)</label>
    <input type="number" id="price" class="form-control" required>

    <label class="mt-2">Address</label>
    <input type="text" id="location" class="form-control" required>

    <button class="btn btn-success w-100 mt-3">Submit</button>
  </form>
</div>

<!-- LISTINGS -->
<div class="list-box mt-4">
  <h4>Your Listings</h4>
  <hr>
  <div id="listingContainer"></div>
</div>

</div>

<script>
// Use window.db directly to avoid any naming conflicts
let formToken = crypto.randomUUID();
let currentLoginId = null;
let currentUsername = null;

// Check authentication FIRST, synchronously (like Dashboard.html)
const loginid = sessionStorage.getItem("loginid");
const usertype = sessionStorage.getItem("usertype");



if (usertype !== "Farmer") {
    alert("Access denied. Only farmers can sell crops.");
    window.location.href = "Dashboard.html";
}

currentLoginId = loginid;

// Wait for DOM and database to be ready, then load data
async function waitForDB() {
  let attempts = 0;
  while (!window.db && attempts < 50) {
    await new Promise(resolve => setTimeout(resolve, 100));
    attempts++;
  }
  if (!window.db) {
    console.error("Database client not available after waiting");
    return false;
  }
  return true;
}

async function init() {
  // Wait for DOM to be ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
    return;
  }

  // Wait for database to be ready
  const dbReady = await waitForDB();
  if (!dbReady) {
    alert("Database connection failed. Please refresh the page.");
    return;
  }

  // Get username from database
  try {
    const { data: userData, error: userError } = await window.db
      .from("logindata")
      .select("username")
      .eq("loginid", loginid)
      .maybeSingle();

    if (userError) {
      console.error("Error fetching user data:", userError);
      alert("Error loading user data: " + userError.message);
      return;
    }

    if (!userData) {
      console.error("User data not found for loginid:", loginid);
      alert("User not found. Please login again.");
      window.location.href = "login.html";
      return;
    }

    currentUsername = userData.username;
    const farmerNameInput = document.getElementById('farmerName');
    if (farmerNameInput) {
      farmerNameInput.value = currentUsername;
    }

    if (new URLSearchParams(location.search).has("success")) {
      const messageBox = document.getElementById('messageBox');
      if (messageBox) {
        messageBox.innerHTML = "<div class='success'>ðŸŒ¾ Crop listed successfully!</div>";
      }
    }

    loadListings(loginid);
  } catch (error) {
    console.error("Unexpected error in init:", error);
    alert("An error occurred. Please try again.");
  }
}
document.getElementById('sellForm').addEventListener('submit', async e => {
  e.preventDefault();

  if (!formToken) return;

  const loginid = sessionStorage.getItem("loginid");
  if (!loginid) {
    alert("Please login again");
    location.href = "login.html";
    return;
  }

  const { count, error: countError } = await window.db
    .from('crop_sales')
    .select('*', { count: 'exact', head: true })
    .eq('ID', loginid);

  if (countError) {
    console.error("Error counting listings:", countError);
    alert("Error: " + countError.message);
    return;
  }

  const jid = `${loginid}-${(count || 0) + 1}`;

  const cropName = document.getElementById('crop_name').value;
  const quantity = document.getElementById('quantity').value;
  const price = document.getElementById('price').value;
  const location = document.getElementById('location').value;

  const { data, error } = await window.db.from('crop_sales').insert({
    ID: loginid,
    JID: jid,
    farmer_name: currentUsername,
    crop_name: cropName,
    quantity: quantity,
    price: price,
    location: location,
    created_at: new Date().toISOString(),
    LID: loginid
  });

  if (error) {
    console.error("Error inserting crop:", error);
    alert("Error saving crop: " + error.message);
    return;
  }

  formToken = null;
  location.search = "?success=1";
});
async function loadListings(uid) {
  const { data, error } = await window.db
    .from('crop_sales')
    .select('*')
    .eq('ID', uid)
    .order('created_at', { ascending: false });

  if (error) {
    console.error("Error loading listings:", error);
    document.getElementById('listingContainer').innerHTML = 
      "<p class='text-danger'>Error loading listings: " + error.message + "</p>";
    return;
  }

  const box = document.getElementById('listingContainer');
  box.innerHTML = '';

  if (!data || data.length === 0) {
    box.innerHTML = "<p class='text-muted'>No listings yet.</p>";
    return;
  }

  data.forEach(row => {
    box.innerHTML += `
      <div class="card p-3 mb-3">
        <strong>${row.crop_name}</strong><br>
        Qty: ${row.quantity} kg<br>
        Price: â‚¹${row.price}/kg<br>
        Address: ${row.location}<br>
        Time: ${row.created_at}<br>
        <button class="btn btn-danger btn-sm mt-2"
          onclick="deleteListing('${row.created_at}')">
          Delete
        </button>
      </div>
    `;
  });
}
async function deleteListing(created_at) {
  if (!confirm("Delete this listing?")) return;

  const loginid = sessionStorage.getItem("loginid");
  if (!loginid) {
    alert("Please login again");
    location.href = "login.html";
    return;
  }

  const { error } = await window.db
    .from('crop_sales')
    .delete()
    .eq('ID', loginid)
    .eq('created_at', created_at);

  if (error) {
    console.error("Error deleting listing:", error);
    alert("Error deleting listing: " + error.message);
    return;
  }

  loadListings(loginid);
}
document.getElementById('logoutBtn').onclick = () => {
  sessionStorage.clear();
  location.href = "login.html";
};

// Start initialization
init();
</script>

</body>
</html>
