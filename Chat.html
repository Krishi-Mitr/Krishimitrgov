<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Chat | Saathi</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="supabase.js"></script>

<style>
body{
  font-family:'Segoe UI',Tahoma,Verdana,sans-serif;
  margin:0;
  background:#f5f5f5;
}

.top-nav{
  display:flex;
  justify-content:space-between;
  align-items:center;
  background:#FF9933;
  padding:15px 40px;
}

.nav-box{
  background:#138808;
  color:#fff;
  padding:10px 22px;
  border-radius:12px;
  text-decoration:none;
  font-weight:bold;
}

.logout-btn{
  font-weight:bold;
  cursor:pointer;
}

.container{
  max-width:900px;
  margin:40px auto;
  padding:20px;
}

.chat-item{
  background:#fff;
  padding:18px;
  margin-bottom:12px;
  border-radius:12px;
  box-shadow:0 4px 10px rgba(0,0,0,.1);
  cursor:pointer;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.chat-item:hover{
  background:#f0f0f0;
}

.chat-name{
  font-weight:bold;
}

.chat-last{
  color:#666;
  margin-top:4px;
}

.unread{
  background:red;
  color:white;
  font-size:12px;
  padding:4px 8px;
  border-radius:10px;
}
</style>
</head>

<body>

<div class="top-nav">
  <a href="NewMessage" class="nav-box">+ New Message</a>
  <span class="logout-btn" onclick="logout()">Logout</span>
</div>

<div class="container" id="chatList">
  Loading chats...
</div>

<script>

/* AUTH */
const myLoginId = Number(sessionStorage.getItem("loginid"));
if(!myLoginId){
  location.replace("login");
}

function logout(){
  sessionStorage.clear();
  location.replace("login");
}

const chatList = document.getElementById("chatList");

/* LOAD CONVERSATIONS */
async function loadChats(){

  const { data, error } = await window.db
    .from("chat_conversations")
    .select("*")
    .or(`user1id.eq.${myLoginId},user2id.eq.${myLoginId}`)
    .order("chatid", { ascending:false });

  if(error || !data){
    chatList.innerHTML = "Failed to load chats.";
    return;
  }

  if(data.length === 0){
    chatList.innerHTML = "No conversations yet.";
    return;
  }

  chatList.innerHTML = "";

  data.forEach(chat => {

    const otherId = chat.user1id === myLoginId 
        ? chat.user2id 
        : chat.user1id;

    const otherName = chat.user1id === myLoginId 
        ? chat.user2name 
        : chat.user1name;

    const div = document.createElement("div");
    div.className = "chat-item";

    div.innerHTML = `
      <div>
        <div class="chat-name">${otherName}</div>
        <div class="chat-last">${chat.last_message || ""}</div>
      </div>
      ${chat.unread_for === myLoginId ? '<div class="unread">New</div>' : ''}
    `;

    div.onclick = async () => {

      // Clear unread flag
      if(chat.unread_for === myLoginId){
        await window.db
          .from("chat_conversations")
          .update({ unread_for: null })
          .eq("chatid", chat.chatid);
      }

      // Store chatid for message page
      sessionStorage.setItem("activeChatId", chat.chatid);
      location.href = "Messages";
    };

    chatList.appendChild(div);
  });

}

loadChats();

</script>

</body>
</html>
